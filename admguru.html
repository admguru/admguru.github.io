<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIM G by dervanfauzan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .status-hadir { background: linear-gradient(135deg, #10b981, #059669); }
        .status-sakit { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .status-izin { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .status-alpa { background: linear-gradient(135deg, #ef4444, #dc2626); }
        
        .sidebar-transition { transition: transform 0.3s ease-in-out; }

        .print-only { display: none; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white !important; }
            main { padding: 0 !important; }
        }
        
        @media (max-width: 768px) {
            .mobile-card .mobile-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
                width: 100%;
                margin-top: 0.75rem;
            }
            .mobile-card .status-btn-mobile {
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex">

    <!-- Sidebar Navigation -->
    <aside id="sidebar" class="bg-white w-64 min-h-screen flex-shrink-0 p-4 shadow-2xl fixed md:relative transform -translate-x-full md:translate-x-0 sidebar-transition z-30 no-print">
        <div class="text-center mb-10">
            <h1 class="text-2xl font-bold text-blue-600">SIM G </h1>
            <p class="text-sm text-gray-500">Sistem Pengelolaan Absensi Nilai dan Jurnal Administrasi Guru</p>
        </div>
        <nav class="flex flex-col gap-2">
            <button onclick="showTab('dashboard')" id="tab-dashboard" class="tab-button flex items-center gap-3 px-4 py-3 rounded-lg font-medium">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                <span>Dashboard</span>
            </button>
            <button onclick="showTab('absensi')" id="tab-absensi" class="tab-button flex items-center gap-3 px-4 py-3 rounded-lg font-medium">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                <span>Absensi Harian</span>
            </button>
            <button onclick="showTab('penilaian')" id="tab-penilaian" class="tab-button flex items-center gap-3 px-4 py-3 rounded-lg font-medium">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                <span>Penilaian</span>
            </button>
            <button onclick="showTab('rekap')" id="tab-rekap" class="tab-button flex items-center gap-3 px-4 py-3 rounded-lg font-medium">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" /></svg>
                <span>Rekap & Laporan</span>
            </button>
            <button onclick="showTab('manajemen')" id="tab-manajemen" class="tab-button flex items-center gap-3 px-4 py-3 rounded-lg font-medium">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>
                <span>Manajemen Siswa</span>
            </button>
            <button onclick="showTab('administrasi')" id="tab-administrasi" class="tab-button flex items-center gap-3 px-4 py-3 rounded-lg font-medium">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z" /></svg>
                <span>Administrasi Guru</span>
            </button>
            <button onclick="showTab('setting')" id="tab-setting" class="tab-button flex items-center gap-3 px-4 py-3 rounded-lg font-medium">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.61-1.56-2.99 0a1.532 1.532 0 01-2.286.948c-1.3-.85-3.04.35-2.77 2.164.2.458.092.95-.157 1.258-1.528 1.53-1.528 4.072 0 5.602.249.308.357.8.157 1.258-.271 1.813 1.519 3.013 2.77 2.164a1.532 1.532 0 012.286.948c.379 1.56 2.61 1.56 2.99 0a1.532 1.532 0 012.286-.948c1.3.85 3.04-.35 2.77-2.164-.2-.458-.092-.95.157-1.258 1.528-1.53 1.528-4.072 0-5.602-.249-.308-.357-.8-.157-1.258.271-1.813-1.519-3.013-2.77-2.164a1.532 1.532 0 01-2.286-.948zM8.994 11a1 1 0 100 2h2a1 1 0 100-2h-2z" clip-rule="evenodd" /></svg>
                <span>Setting</span>
            </button>
        </nav>
    </aside>

    <!-- Overlay for mobile -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden" onclick="toggleSidebar()"></div>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-6 overflow-y-auto flex flex-col justify-between h-screen">
        <div>
            <!-- Main Header -->
            <div class="bg-white rounded-2xl shadow-xl p-4 mb-6 flex items-center justify-between no-print">
                <button id="hamburger" class="md:hidden p-2 rounded-md hover:bg-gray-100" onclick="toggleSidebar()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <div class="flex-1 text-center md:text-left">
                     <h1 class="text-xl md:text-2xl font-bold text-gray-800">Salam Hormat Bapak Ibu Guru!</h1>
                     <p class="text-sm text-gray-500">Sistem Pengelolaan Absensi Nilai dan Jurnal Administrasi Guru ini dibuat oleh D. Ervan Fauzan, S.Sos, Gr.</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-right hidden sm:block">
                        <div class="text-sm text-gray-500">Tanggal Hari Ini</div>
                        <div id="currentDate" class="font-semibold text-gray-800"></div>
                    </div>
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center text-white text-xl">
                        📅
                    </div>
                </div>
            </div>

            <!-- Tab Content Area -->
            <div id="content-dashboard" class="tab-content"></div>
            <div id="content-absensi" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                    <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">Absensi Harian</h2>
                            <p class="text-gray-600">Pilih kelas dan lakukan presensi siswa</p>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                        <div class="flex flex-wrap gap-3 items-center">
                             <select id="kelasSelect" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Pilih Kelas</option>
                            </select>
                            <input type="date" id="tanggalAbsen" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div class="flex flex-wrap gap-3 items-center">
                            <button onclick="hadirSemua()" class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-6 py-3 rounded-lg font-medium hover:from-blue-600 hover:to-indigo-700 transition-all duration-200 shadow-lg">✅ Hadir Semua</button>
                            <button onclick="showTab('dashboard')" class="bg-gray-200 text-gray-800 px-6 py-3 rounded-lg font-medium hover:bg-gray-300 transition-all duration-200 shadow-lg">🏠 Check Dashboard</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                        <div class="status-hadir text-white p-3 rounded-lg text-center"><div class="font-semibold">✅ Hadir</div><div class="text-sm opacity-90">Siswa hadir</div></div>
                        <div class="status-sakit text-white p-3 rounded-lg text-center"><div class="font-semibold">🤒 Sakit</div><div class="text-sm opacity-90">Tidak hadir karena sakit</div></div>
                        <div class="status-izin text-white p-3 rounded-lg text-center"><div class="font-semibold">📝 Izin</div><div class="text-sm opacity-90">Tidak hadir dengan izin</div></div>
                        <div class="status-alpa text-white p-3 rounded-lg text-center"><div class="font-semibold">❌ Alpa</div><div class="text-sm opacity-90">Tidak hadir tanpa keterangan</div></div>
                    </div>
                    <div id="daftarSiswa" class="space-y-3"><div class="text-center text-gray-500 py-8"><div class="text-4xl mb-3">👥</div><p>Pilih kelas untuk menampilkan daftar siswa</p></div></div>
                    <div id="actionButtons" class="mt-6 flex flex-wrap gap-3 justify-center" style="display: none;">
                        <button onclick="simpanAbsensi()" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-lg font-medium hover:from-green-600 hover:to-green-700 transition-all duration-200 shadow-lg">💾 Simpan Absensi</button>
                        <button onclick="resetAbsensi()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-lg font-medium hover:from-gray-600 hover:to-gray-700 transition-all duration-200 shadow-lg">🔄 Reset</button>
                    </div>
                </div>
            </div>
            
            <div id="content-penilaian" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                    <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">Penilaian</h2>
                            <p class="text-gray-600">Input nilai harian dan nilai tugas siswa</p>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <select id="penilaianKelas" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"><option value="">Pilih Kelas</option></select>
                            <input type="date" id="tanggalNilai" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <input type="text" id="materiNilai" placeholder="Materi Penilaian (Contoh: Bab 1)" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    <div id="daftarNilai" class="space-y-3"><div class="text-center text-gray-500 py-8"><div class="text-4xl mb-3">📝</div><p>Pilih kelas dan tanggal untuk memasukkan nilai</p></div></div>
                    <div id="actionNilaiButtons" class="mt-6 flex flex-wrap gap-3 justify-center" style="display: none;">
                        <button onclick="simpanNilai()" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-lg font-medium hover:from-green-600 hover:to-green-700 transition-all duration-200 shadow-lg">💾 Simpan Nilai</button>
                    </div>
                </div>
            </div>

            <!-- Combined Rekap & Laporan Tab -->
            <div id="content-rekap" class="tab-content hidden"></div>
            
            <div id="content-manajemen" class="tab-content hidden"></div>
            <div id="content-administrasi" class="tab-content hidden"></div>
            <div id="content-setting" class="tab-content hidden"></div>
        </div>
        
        <!-- Footer with credits -->
        <footer class="text-center py-4 no-print">
            <p class="text-sm text-gray-500">Sistem ini dibuat oleh D. Ervan Fauzan, S.Sos, Gr.</p>
        </footer>
    </main>

    <script>
        // Data Awal Siswa, digunakan jika localStorage kosong.
        const initialDataSiswa = {
            "12 LP": [{nis: "2324.10.1264", nama: "Alma Alini Saputri", jk: "P"}, {nis: "2324.10.1265", nama: "Amelia Putri M.D", jk: "P"}, {nis: "2324.10.1268", nama: "Dahlia", jk: "P"}, {nis: "2324.10.1269", nama: "Decha Destiani", jk: "P"}, {nis: "2324.10.1270", nama: "Diana", jk: "P"}, {nis: "2324.10.1271", nama: "Dimas Saputra", jk: "L"}, {nis: "2023.10.1273", nama: "Intan Riskawati", jk: "P"}, {nis: "2023.10.1274", nama: "Isqilah Khoerul Umah", jk: "P"}, {nis: "2023.10.1275", nama: "Laisa Apriyanti", jk: "P"}, {nis: "2023.10.1276", nama: "Lanlan", jk: "L"}, {nis: "2023.10.1277", nama: "Leni Astuti", jk: "P"}, {nis: "2023.10.1279", nama: "Moch.Reihan", jk: "L"}, {nis: "2023.10.1280", nama: "Naila Apriliani", jk: "P"}, {nis: "2023.10.1281", nama: "Nasya Herdiana Putri", jk: "P"}, {nis: "2023.10.1282", nama: "Nesa Alya Safitri", jk: "P"}, {nis: "2023.10.1283", nama: "Nila Nurmala", jk: "P"}, {nis: "2023.10.1288", nama: "Resiawati", jk: "P"}, {nis: "2023.10.1289", nama: "Riani Nurfadilah", jk: "P"}, {nis: "2023.10.1290", nama: "Riski Aulia", jk: "P"}, {nis: "2023.10.1291", nama: "Rizky Andri Maulana", jk: "L"}, {nis: "2023.10.1292", nama: "Seni Meylani", jk: "P"}, {nis: "2023.10.1293", nama: "Serli", jk: "P"}, {nis: "2324.11.1486", nama: "Siti Fatimah Syifa", jk: "P"}, {nis: "2023.10.1294", nama: "Siti Humaira Risma Wati", jk: "P"}, {nis: "2023.10.1295", nama: "Tasya Kamila", jk: "P"}, {nis: "2023.10.1296", nama: "Windi", jk: "P"}],
            "12 TKR": [{nis: "2324.10.1297", nama: "Akbar Maulana", jk: "L"}, {nis: "2324.10.1299", nama: "Bayu Rusdi Wijaya", jk: "L"}, {nis: "2324.10.1300", nama: "Eundi", jk: "L"}, {nis: "2324.10.1302", nama: "Faisal Alfaizi", jk: "L"}, {nis: "2324.10.1335", nama: "Farhad Aulia Sidiq", jk: "L"}, {nis: "2324.10.1303", nama: "Farhan Mudzoffar", jk: "L"}, {nis: "2324.10.1305", nama: "Ilham", jk: "L"}, {nis: "2324.11.1487", nama: "M. Galank Pratama", jk: "L"}, {nis: "2324.10.1306", nama: "M. Reyihan Maulana", jk: "L"}, {nis: "2324.10.1307", nama: "M. Riezuan Ibrahim Putra", jk: "L"}, {nis: "2324.10.1308", nama: "M. Ripal", jk: "L"}, {nis: "2324.10.1309", nama: "Muhamad Rizky Maulana", jk: "L"}, {nis: "2324.10.1310", nama: "Muhamad Sandi", jk: "L"}, {nis: "2324.10.1284", nama: "Pandu Krisnaldi", jk: "L"}, {nis: "2324.10.1287", nama: "Reinaldi Ade Putra", jk: "L"}, {nis: "2324.10.1311", nama: "Riski Ade Almiraj", jk: "L"}, {nis: "2324.11.1342", nama: "Rizki Firmansyah", jk: "L"}, {nis: "2324.10.1313", nama: "Tedi Maulana", jk: "L"}, {nis: "2324.10.1336", nama: "Topik", jk: "L"}, {nis: "2324.10.1315", nama: "Viter Herlambang", jk: "L"}],
            "12 RPL 1": [{nis: "2324.10.1207", nama: "Abdul Malik", jk: "L"}, {nis: "2324.10.1208", nama: "Ahwana Maulana", jk: "L"}, {nis: "2324.10.1209", nama: "Aldo Supardi", jk: "L"}, {nis: "2324.10.1210", nama: "Alfayiril Ramadan", jk: "L"}, {nis: "2324.10.1211", nama: "Alpin Dika Aulia", jk: "L"}, {nis: "2324.10.1212", nama: "Ariska Rahma Wati", jk: "P"}, {nis: "2324.10.1213", nama: "Bunga Aulia Nurplah", jk: "P"}, {nis: "2324.10.1214", nama: "Deden Suryana", jk: "L"}, {nis: "2324.10.1215", nama: "Didi Mardiana", jk: "L"}, {nis: "2324.10.1331", nama: "Dzanis Ginanjar", jk: "L"}, {nis: "2324.10.1217", nama: "Gia Moza Lestari", jk: "P"}, {nis: "2324.10.1218", nama: "Hudda Rodiyah Hartari", jk: "L"}, {nis: "2324.10.1219", nama: "Ikbal Maulana Rizki", jk: "L"}, {nis: "2324.10.1220", nama: "Ilma", jk: "P"}, {nis: "2324.10.1221", nama: "M.Dhika Syahputra", jk: "L"}, {nis: "2324.10.1222", nama: "M.Nur Alpin", jk: "L"}, {nis: "2324.10.1223", nama: "Malla", jk: "P"}, {nis: "2324.10.1224", nama: "Maura Puring Lisnawati", jk: "P"}, {nis: "2324.10.1225", nama: "Nur Salwa", jk: "P"}, {nis: "2324.10.1226", nama: "Pahri Akbar", jk: "L"}, {nis: "2324.10.1228", nama: "Reno Ronal", jk: "L"}, {nis: "2324.10.1229", nama: "Rika Ardila", jk: "P"}, {nis: "2324.10.1230", nama: "Saepul Gunawan", jk: "L"}, {nis: "2324.10.1231", nama: "Salwa safitri", jk: "P"}, {nis: "2324.10.1232", nama: "Siti Nuraeni", jk: "P"}, {nis: "2324.10.1233", nama: "Siti Zahro", jk: "P"}, {nis: "2324.10.1234", nama: "Zalpa Nurlaela", jk: "P"}],
            "12 RPL 2": [{nis: "2324.10.1235", nama: "Aji Santoso", jk: "L"}, {nis: "2324.10.1236", nama: "Ardiansyah", jk: "L"}, {nis: "2324.10.1237", nama: "Ariel Apriado", jk: "L"}, {nis: "2324.10.1238", nama: "Arif Rohman", jk: "L"}, {nis: "2324.10.1239", nama: "Aril Dimas Saputra", jk: "L"}, {nis: "2324.10.1240", nama: "Azril Apandi", jk: "L"}, {nis: "2324.10.1241", nama: "Bunga Lestari", jk: "P"}, {nis: "2324.10.1242", nama: "Deiz Herlangga", jk: "L"}, {nis: "2324.10.1243", nama: "Devin Andrea", jk: "L"}, {nis: "2425.11.1489", nama: "Dihyara El-Qolbi Ismatullah", jk: "L"}, {nis: "2324.10.1244", nama: "Eka Armawiria", jk: "P"}, {nis: "2324.10.1245", nama: "Eka Zilvia", jk: "P"}, {nis: "2324.10.1246", nama: "Elfani Ajeng Lutfiah", jk: "P"}, {nis: "2324.10.1247", nama: "Eneng Sarah", jk: "P"}, {nis: "2324.10.1248", nama: "Hergi Eka Putra Juniansyah", jk: "L"}, {nis: "2324.10.1249", nama: "Jesicka", jk: "P"}, {nis: "2324.10.1250", nama: "M Ziehad Alfazri", jk: "L"}, {nis: "2324.10.1251", nama: "M. Aris Nawawi", jk: "L"}, {nis: "2324.10.1252", nama: "Nurul Hikmah", jk: "P"}, {nis: "2324.10.1286", nama: "Piki", jk: "L"}, {nis: "2324.10.1253", nama: "Putra M.Saepul Hanan", jk: "L"}, {nis: "2324.10.1254", nama: "Putri Indah Lestari", jk: "P"}, {nis: "2324.10.1255", nama: "Rafi", jk: "L"}, {nis: "2324.10.1256", nama: "Ragil Maulana", jk: "L"}, {nis: "2324.10.1257", nama: "Rahman", jk: "L"}, {nis: "2324.10.1258", nama: "Rahmawati", jk: "P"}, {nis: "2324.10.1259", nama: "Rapsan Sahid", jk: "L"}, {nis: "2324.10.1227", nama: "Rayan Ramadhani", jk: "L"}, {nis: "2324.10.1260", nama: "Salwa Febriyanti", jk: "P"}, {nis: "2324.10.1261", nama: "Sindi Aulia", jk: "P"}, {nis: "2324.10.1262", nama: "Siti Lestari", jk: "P"}, {nis: "2324.10.1263", nama: "Zenal Arif", jk: "L"}],
            "12 DPB": [{nis: "2324.10.1316", nama: "Abdul Muiz", jk: "L"}, {nis: "2324.10.1317", nama: "Alsa", jk: "P"}, {nis: "2324.10.1267", nama: "Berliana", jk: "P"}, {nis: "2324.10.1272", nama: "Icha Risnawati", jk: "P"}, {nis: "2324.10.1320", nama: "Kaliza Destriani", jk: "P"}, {nis: "2324.10.1321", nama: "Latifahtu Khairiah", jk: "P"}, {nis: "2324.10.1337", nama: "Parid Pratama", jk: "L"}, {nis: "2324.10.1323", nama: "Perdi Nurohman", jk: "L"}, {nis: "2324.10.1343", nama: "Putri Lestari", jk: "P"}, {nis: "2324.10.1324", nama: "Rismiati", jk: "P"}, {nis: "2324.10.1325", nama: "Sajid", jk: "L"}, {nis: "2324.10.1326", nama: "Salma Susanto", jk: "P"}, {nis: "2324.10.1332", nama: "Shabrina", jk: "P"}, {nis: "2324.10.1327", nama: "Siti Anida Putri Agustian", jk: "P"}, {nis: "2324.10.1328", nama: "Siti Fadilah", jk: "P"}, {nis: "2324.10.1329", nama: "Tesa", jk: "P"}],
            "11 RPL 1": [{nis: "2425.10.1345", nama: "ADIYANSYAH", jk: "L"}, {nis: "2425.10.1346", nama: "ALDI MUHAMMAD SHANDI", jk: "L"}, {nis: "2425.10.1347", nama: "ANDIKA PRATAMA", jk: "L"}, {nis: "2425.10.1348", nama: "ANDRI YANSYAH", jk: "L"}, {nis: "2425.10.1349", nama: "ANTENG SRI LESTARI", jk: "P"}, {nis: "2425.10.1350", nama: "EVA MAULIDA", jk: "P"}, {nis: "2425.10.1351", nama: "FAISAL RIZKI FARSA", jk: "L"}, {nis: "2425.10.1352", nama: "INA PEBRIANI", jk: "P"}, {nis: "2425.10.1353", nama: "JESSICA MAHARANI", jk: "P"}, {nis: "2425.10.1354", nama: "KAYANA RAISA PUTRA", jk: "P"}, {nis: "2425.10.1355", nama: "KUMARUL RIFA", jk: "L"}, {nis: "2425.10.1356", nama: "LATISA AMALIA", jk: "P"}, {nis: "2425.10.1357", nama: "M ABDIELAH HERDIANA HERDIANSYAH", jk: "L"}, {nis: "2425.10.1358", nama: "MARSA", jk: "P"}, {nis: "2425.10.1359", nama: "MUHAMAD FAHRI PRATAMA", jk: "L"}, {nis: "2425.10.1361", nama: "MUHAMMAD ABDUL LATIF", jk: "L"}, {nis: "2425.10.1362", nama: "MUHAMMAD RAFIL APRILIANTO", jk: "L"}, {nis: "2425.10.1363", nama: "NIZAR FIRMAN HIDAYAT", jk: "L"}, {nis: "2425.10.1364", nama: "PASKAL ALPARADO DASTIAN", jk: "L"}, {nis: "2425.10.1365", nama: "RADIT YUSUF MAULANA SUSANTO", jk: "L"}, {nis: "2425.10.1366", nama: "REGI A MAULANA", jk: "L"}, {nis: "2425.10.1367", nama: "RENDI", jk: "L"}, {nis: "2425.10.1368", nama: "RIMA MIATI FAUZI", jk: "P"}, {nis: "2425.10.1369", nama: "RIPAL PEBRIANA", jk: "L"}, {nis: "2425.10.1370", nama: "RISDA AMELIA", jk: "P"}, {nis: "2425.10.1371", nama: "SILVIANI SAFITRI", jk: "P"}, {nis: "2425.10.1372", nama: "SISKA NURHASANAH", jk: "P"}, {nis: "2425.10.1373", nama: "SOHIPA", jk: "P"}, {nis: "2425.10.1374", nama: "TINA TALISA", jk: "P"}, {nis: "2425.10.1375", nama: "WENDI RAMADHANI", jk: "L"}],
            "11 RPL 2": [{nis: "2425.10.1376", nama: "ABDUL MUIZ", jk: "L"}, {nis: "2425.10.1377", nama: "ADITIA", jk: "L"}, {nis: "2425.10.1378", nama: "ALIF AMRILAH", jk: "L"}, {nis: "2425.10.1379", nama: "ARIS SUPRIATMAN", jk: "L"}, {nis: "2425.10.1380", nama: "ASEP LENDRA", jk: "L"}, {nis: "2425.10.1381", nama: "AULIA HAFIZAH", jk: "P"}, {nis: "2425.10.1382", nama: "AYU HERMAWAN", jk: "P"}, {nis: "2425.10.1383", nama: "CHANTIKA LUSIANA DEWI", jk: "P"}, {nis: "2425.10.1384", nama: "DHILAL MULTAZAM", jk: "L"}, {nis: "2425.10.1385", nama: "DIMAS APRILIAN NUGRAHA", jk: "L"}, {nis: "2425.10.1386", nama: "FIKRI ALFARIZI", jk: "L"}, {nis: "2425.10.1387", nama: "GUNTUR PADILAH", jk: "L"}, {nis: "2425.10.1388", nama: "M FARIDZ ALBAHRI", jk: "L"}, {nis: "2425.10.1389", nama: "M. SOLAHUDIN NURARIPIN", jk: "L"}, {nis: "2425.10.1390", nama: "M.RIFKI", jk: "L"}, {nis: "2425.10.1391", nama: "MEISKA CAHAYA RAHAYU", jk: "P"}, {nis: "2425.10.1392", nama: "MOCH. KHALID AR-RAHMAN", jk: "L"}, {nis: "2425.10.1393", nama: "MUHAMAD FAIQ AYUBI", jk: "L"}, {nis: "2425.10.1394", nama: "MUHAMAD IRFAN", jk: "L"}, {nis: "2425.10.1395", nama: "MUHAMMAD ELPAN MAULANA", jk: "L"}, {nis: "2425.10.1396", nama: "MUHAMMAD REVANJAELANI", jk: "L"}, {nis: "2425.10.1397", nama: "NENG INTAN NURRIZQIA", jk: "P"}, {nis: "2425.10.1398", nama: "NUR SYIFA AINI", jk: "P"}, {nis: "2425.10.1399", nama: "RAENALDO", jk: "L"}, {nis: "2425.10.1400", nama: "RAISYA MEISYARA", jk: "P"}, {nis: "2425.10.1401", nama: "RENAL MAULANA", jk: "L"}, {nis: "2425.10.1402", nama: "RENALDY DRAJAT PRANAJAYA", jk: "L"}, {nis: "2425.10.1403", nama: "REPAN", jk: "L"}, {nis: "2425.10.1404", nama: "SALVA RAMADHANI", jk: "P"}, {nis: "2425.10.1405", nama: "SYIFA ALENA PUTRI", jk: "P"}, {nis: "2425.10.1406", nama: "TOPAN GRUDA TEJO SANDHYKA", jk: "L"}, {nis: "2425.10.1407", nama: "VINA JULIANTI", jk: "P"}],
            "11 DPB": [{nis: "2425.10.1408", nama: "ALBA", jk: "L"}, {nis: "2425.10.1409", nama: "ANDRE MAULANA", jk: "L"}, {nis: "2425.10.1410", nama: "DHIYA MAULIDA", jk: "P"}, {nis: "2425.10.1411", nama: "ETIKA LESWATI", jk: "P"}, {nis: "2425.10.1412", nama: "EVA ZAKIYAH", jk: "P"}, {nis: "2425.10.1413", nama: "HANNIYA CHANTIKA J", jk: "P"}, {nis: "2425.10.1414", nama: "KESSYA TANTRI", jk: "P"}, {nis: "2425.10.1415", nama: "KHUTBIATUN NISAROPAH", jk: "P"}, {nis: "2425.10.1416", nama: "NAJWA HUSWATUN H", jk: "P"}, {nis: "2425.10.1417", nama: "NAZMA SRI MALA", jk: "P"}, {nis: "2425.10.1419", nama: "PEBYA SUDARMAN", jk: "P"}, {nis: "2425.10.1420", nama: "RESTI", jk: "P"}, {nis: "2425.10.1421", nama: "RIO APRRIANSAH", jk: "L"}, {nis: "2425.10.1422", nama: "SALSA SABILA", jk: "P"}, {nis: "2425.10.1424", nama: "SITI NUR AMALIA", jk: "P"}, {nis: "2425.10.1425", nama: "SYIFA DIAH MAULIYANA", jk: "P"}, {nis: "2425.10.1426", nama: "TIA HARYATI", jk: "P"}, {nis: "2425.10.1427", nama: "YOSI", jk: "P"}, {nis: "2425.10.1428", nama: "ZAHRA MAULIDA", jk: "P"}],
            "11 TKR": [{nis: "2425.10.1429", nama: "ALBAR YUSUF", jk: "L"}, {nis: "2425.10.1431", nama: "ANDRA RADITTIA", jk: "L"}, {nis: "2425.10.1432", nama: "ANGGI", jk: "L"}, {nis: "2425.10.1433", nama: "ANGGI SAPUTRA", jk: "L"}, {nis: "2425.10.1434", nama: "FAHRI ALMAIZ", jk: "L"}, {nis: "2425.10.1435", nama: "FAJAR KIAN", jk: "L"}, {nis: "2425.10.1436", nama: "FAKHRI YUSUF HAIDAR", jk: "L"}, {nis: "2425.10.1437", nama: "FAUZAN TRI SURYA SAPUTRA", jk: "L"}, {nis: "2425.10.1438", nama: "IRGI DIAN SAPUTRA", jk: "L"}, {nis: "2425.10.1439", nama: "M AGIS", jk: "L"}, {nis: "2425.10.1440", nama: "M ALPIAN", jk: "L"}, {nis: "2425.10.1441", nama: "M PAHMI", jk: "L"}, {nis: "2425.10.1442", nama: "M. PIKRI", jk: "L"}, {nis: "2425.10.1443", nama: "M.MANSHUR", jk: "L"}, {nis: "2425.10.1444", nama: "MAHESA SAPUTRA", jk: "L"}, {nis: "2425.10.1445", nama: "MOCH ERLANGGA", jk: "L"}, {nis: "2425.10.1446", nama: "MOH RIZKY ALFHARIZ FAISAL IDRIS", jk: "L"}, {nis: "2425.10.1484", nama: "MUHAMAD RAFI RUSTIAWAN", jk: "L"}, {nis: "2425.10.1448", nama: "MUHAMMAD AKBIL", jk: "L"}, {nis: "2425.10.1449", nama: "PANDI", jk: "L"}, {nis: "2425.10.1450", nama: "RAFKA ADI PERMANA", jk: "L"}, {nis: "2425.10.1451", nama: "RAHIL MAULANA AWALI", jk: "L"}, {nis: "2425.10.1452", nama: "RENDI", jk: "L"}, {nis: "2425.10.1453", nama: "RIPAL", jk: "L"}, {nis: "2425.10.1454", nama: "SUHERLI RAMA DANI", jk: "L"}, {nis: "2425.10.1455", nama: "SURYA BUDI PRATAMA", jk: "L"}, {nis: "2425.10.1456", nama: "SUSILO", jk: "L"}],
            "10 TKR 1": [{nis: "2526.10.1608", nama: "Abdul Aziz", jk: "L"}, {nis: "2526.10.1609", nama: "Abdul Hilman", jk: "L"}, {nis: "2526.10.1610", nama: "Aden Juminta", jk: "L"}, {nis: "2526.10.1611", nama: "Afrijal", jk: "L"}, {nis: "2526.10.1612", nama: "Aldo Sutisno", jk: "L"}, {nis: "2526.10.1613", nama: "Andika Pratama", jk: "L"}, {nis: "2526.10.1614", nama: "Andrean", jk: "L"}, {nis: "2526.10.1615", nama: "Daud Atohillah", jk: "L"}, {nis: "2526.10.1616", nama: "Diaz Aditya", jk: "L"}, {nis: "2526.10.1617", nama: "Faisal Nurhayat", jk: "L"}, {nis: "2526.10.1618", nama: "M. Dzikri Fadilah", jk: "L"}, {nis: "2526.10.1619", nama: "Muhamad Aldiansyah", jk: "L"}, {nis: "2526.10.1620", nama: "Muhamad Kholiq Abdul Kiram", jk: "L"}, {nis: "2526.10.1621", nama: "Muhamad Saepul Kamal", jk: "L"}, {nis: "2526.10.1622", nama: "Pasa", jk: "L"}, {nis: "2526.10.1623", nama: "Raffa Tubagus Sulistio", jk: "L"}, {nis: "2526.10.1624", nama: "Ratu Tashi", jk: "P"}, {nis: "2526.10.1625", nama: "Rayi Suwandi", jk: "L"}, {nis: "2526.10.1626", nama: "Rehan", jk: "L"}, {nis: "2526.10.1627", nama: "Reyhan", jk: "L"}, {nis: "2526.10.1628", nama: "Riski Andriyan", jk: "L"}, {nis: "2526.10.1629", nama: "Rizqi Raditia", jk: "L"}, {nis: "2526.10.1630", nama: "Vikri Maulana Yusuf", jk: "L"}],
            "10 DPB": [{nis: "2526.10.1491", nama: "Alfatir Fatara", jk: "L"}, {nis: "2526.10.1492", nama: "Alvi Nelani Putri", jk: "P"}, {nis: "2526.10.1493", nama: "Amelia", jk: "P"}, {nis: "2526.10.1494", nama: "Azka Aulia", jk: "P"}, {nis: "2526.10.1495", nama: "Bonita Susanto", jk: "P"}, {nis: "2526.10.1496", nama: "Celyn Al Ismi", jk: "P"}, {nis: "2526.10.1497", nama: "Dewi Rosita Puspitasari", jk: "P"}, {nis: "2526.10.1498", nama: "Haikal Prandani", jk: "L"}, {nis: "2526.10.1499", nama: "Muhamad Fadhil Ramdani", jk: "L"}, {nis: "2526.10.1500", nama: "Muhamad Muklis Pahmi", jk: "L"}, {nis: "2526.10.1501", nama: "Muhamad Wildan", jk: "L"}, {nis: "2526.10.1502", nama: "Nabil Anggara Putra", jk: "L"}, {nis: "2526.10.1503", nama: "Noviana Dewi", jk: "P"}, {nis: "2526.10.1504", nama: "Nurul Fauziyah", jk: "P"}, {nis: "2526.10.1505", nama: "Paisal Mauala", jk: "L"}, {nis: "2526.10.1506", nama: "Radit Alfarizy", jk: "L"}, {nis: "2526.10.1507", nama: "Rayyan Khallid", jk: "L"}, {nis: "2526.10.1508", nama: "Salsabil Fitri", jk: "P"}, {nis: "2526.10.1509", nama: "Shaskia Raydinata Agustian", jk: "P"}, {nis: "2526.10.1510", nama: "Sintia Wulansa Purnama", jk: "P"}, {nis: "2526.10.1511", nama: "Siti Nabila", jk: "P"}, {nis: "2526.10.1512", nama: "Siti Rosidah", jk: "P"}],
            "10 RPL 1": [{nis: "2526.10.1547", nama: "Aditya Zian Pangestu", jk: "L"}, {nis: "2526.10.1548", nama: "Afrijal", jk: "L"}, {nis: "2526.10.1549", nama: "Ai Rohimatul M", jk: "P"}, {nis: "2526.10.1550", nama: "Aldi", jk: "L"}, {nis: "2526.10.1551", nama: "Aldi Nur Falah", jk: "L"}, {nis: "2526.10.1552", nama: "Alif Imam Rojak", jk: "L"}, {nis: "2526.10.1553", nama: "Bagas Rizki Wanggeni", jk: "L"}, {nis: "2526.10.1554", nama: "Elsa", jk: "P"}, {nis: "2526.10.1555", nama: "Gibran Qais Ramadhan", jk: "L"}, {nis: "2526.10.1556", nama: "Jihan Lestari", jk: "P"}, {nis: "2526.10.1557", nama: "Kahfi Alam", jk: "L"}, {nis: "2526.10.1558", nama: "Karisma", jk: "P"}, {nis: "2526.10.1559", nama: "M. Abdul Muiz", jk: "L"}, {nis: "2526.10.1560", nama: "M. Fajar Hamdani", jk: "L"}, {nis: "2526.10.1561", nama: "M. Hifdzy Nur Awal", jk: "L"}, {nis: "2526.10.1562", nama: "M. Hilal", jk: "L"}, {nis: "2526.10.1563", nama: "Marsya Denita", jk: "P"}, {nis: "2526.10.1564", nama: "Muhamad Idris Maulana", jk: "L"}, {nis: "2526.10.1565", nama: "Muhamad Ihsan", jk: "L"}, {nis: "2526.10.1566", nama: "Muhamad Ilham", jk: "L"}, {nis: "2526.10.1567", nama: "Nanda Septian", jk: "L"}, {nis: "2526.10.1568", nama: "Nuril Azhari", jk: "L"}, {nis: "2526.10.1569", nama: "Raden Muhamad Fadlan Putra Yulia", jk: "L"}, {nis: "2526.10.1570", nama: "Radja Rayhan Eka Setibudi", jk: "L"}, {nis: "2526.10.1571", nama: "Raja. M Parhan", jk: "L"}, {nis: "2526.10.1572", nama: "Ramadhan Pratama", jk: "L"}, {nis: "2526.10.1573", nama: "Rapi Maulana Sahid", jk: "L"}, {nis: "2526.10.1574", nama: "Resti Melani", jk: "P"}, {nis: "2526.10.1575", nama: "Safana Susanto", jk: "P"}, {nis: "2526.10.1576", nama: "Sri Andini", jk: "P"}, {nis: "2526.10.1577", nama: "Teguh Dafa Oktaviana", jk: "L"}],
            "10 RPL 2": [{nis: "2526.10.1578", nama: "Abdul Satrio", jk: "L"}, {nis: "2526.10.1579", nama: "Aden Permana Hidayatuloh", jk: "L"}, {nis: "2526.10.1580", nama: "Adis Al Gojali", jk: "L"}, {nis: "2526.10.1582", nama: "Bayu Sukma", jk: "L"}, {nis: "2526.10.1583", nama: "Dimas", jk: "L"}, {nis: "2526.10.1584", nama: "Gun Gun", jk: "L"}, {nis: "2526.10.1585", nama: "Hanifah", jk: "P"}, {nis: "2526.10.1586", nama: "Kayla", jk: "P"}, {nis: "2526.10.1587", nama: "Langit Saputra", jk: "L"}, {nis: "2526.10.1588", nama: "M. Aditia Ramadhani", jk: "L"}, {nis: "2526.10.1589", nama: "M. Rangga Jaya Sakti", jk: "L"}, {nis: "2526.10.1590", nama: "M. Rijal Alpiansyah", jk: "L"}, {nis: "2526.10.1591", nama: "M. Rizki. Hamdani", jk: "L"}, {nis: "2526.10.1592", nama: "M. Rizwan", jk: "L"}, {nis: "2526.10.1593", nama: "Malikal Mulki", jk: "L"}, {nis: "2526.10.1594", nama: "Monica", jk: "P"}, {nis: "2526.10.1595", nama: "Muhamad Ramadan", jk: "L"}, {nis: "2526.10.1596", nama: "Muhamad Rizki Ramdani", jk: "L"}, {nis: "2526.10.1597", nama: "Muhamad Sirojushibiyan", jk: "L"}, {nis: "2526.10.1598", nama: "Naila Hayati", jk: "P"}, {nis: "2526.10.1599", nama: "Nurfa Dwi Rahayu", jk: "P"}, {nis: "2526.10.1600", nama: "Raden Muhamad Fadly Putra Yulia", jk: "L"}, {nis: "2526.10.1601", nama: "Ratna Mustika", jk: "P"}, {nis: "2526.10.1602", nama: "Reza", jk: "L"}, {nis: "2526.10.1603", nama: "Risandi", jk: "L"}, {nis: "2526.10.1604", nama: "Sahar Maesandi", jk: "P"}, {nis: "2526.10.1605", nama: "Syalwa Mahesa", jk: "P"}, {nis: "2526.10.1606", nama: "Vikri Risal Gianto", jk: "L"}, {nis: "2526.10.1607", nama: "Yasir Nurfalah", jk: "L"}, {nis: "2526.10.1581", nama: "Aulia Meilinda Saptiani", jk: "P"}],
            "10 LP": [{nis: "2526.10.1513", nama: "Abdul Aziz", jk: "L"}, {nis: "2526.10.1514", nama: "Ahmad Khusaery", jk: "P"}, {nis: "2526.10.1515", nama: "Aisyah Nur Azzahra", jk: "P"}, {nis: "2526.10.1516", nama: "Arif Rahman Efendi", jk: "L"}, {nis: "2526.10.1517", nama: "Asti dea astuti", jk: "P"}, {nis: "2526.10.1518", nama: "Aulia Rahmawati", jk: "P"}, {nis: "2526.10.1519", nama: "Ayu Sri Mulyani", jk: "P"}, {nis: "2526.10.1520", nama: "Dana Mustakim", jk: "L"}, {nis: "2526.10.1521", nama: "Denis", jk: "L"}, {nis: "2526.10.1522", nama: "Eriska", jk: "P"}, {nis: "2526.10.1523", nama: "Fuji Marwah", jk: "P"}, {nis: "2526.10.1524", nama: "Gesha Maryamah", jk: "P"}, {nis: "2526.10.1525", nama: "Hafiz Al Aslah", jk: "L"}, {nis: "2526.10.1526", nama: "Intan Syahrini", jk: "P"}, {nis: "2526.10.1527", nama: "Kiki Sukirah", jk: "P"}, {nis: "2526.10.1528", nama: "M. Abia R.", jk: "L"}, {nis: "2526.10.1529", nama: "M. Habib Gib Al Tariq Warsa Sudarmono", jk: "L"}, {nis: "2526.10.1530", nama: "Muhamad Alip Nur Arafah", jk: "L"}, {nis: "2526.10.1531", nama: "Najwa Khoerunisa", jk: "P"}, {nis: "2526.10.1532", nama: "Neng Melani", jk: "P"}, {nis: "2526.10.1533", nama: "Neng Silva Oktavia", jk: "L"}, {nis: "2526.10.1534", nama: "Nova Agustina", jk: "P"}, {nis: "2526.10.1535", nama: "Reihan Abdullah Fauzy", jk: "L"}, {nis: "2526.10.1536", nama: "Reza Irawan", jk: "L"}, {nis: "2526.10.1537", nama: "Satria Fuji", jk: "L"}, {nis: "2526.10.1538", nama: "Seli Rahmawati", jk: "P"}, {nis: "2526.10.1539", nama: "Shipa Pebriana", jk: "P"}, {nis: "2526.10.1540", nama: "Siska Yusvita Sari", jk: "P"}, {nis: "2526.10.1541", nama: "Siswa Tanpa Nama", jk: "P"}, {nis: "2526.10.1542", nama: "Siti Rismawati", jk: "P"}, {nis: "2526.10.1543", nama: "Siti Sarah", jk: "P"}, {nis: "2526.10.1544", nama: "Sri Sanjani", jk: "P"}, {nis: "2526.10.1545", nama: "Tiara Alika Sari", jk: "P"}, {nis: "2526.10.1546", nama: "Vina Sri Ripian", jk: "P"}]
        };

        // Memuat data dari localStorage. Jika tidak ada, gunakan data awal.
        let dataSiswa = JSON.parse(localStorage.getItem('dataSiswa')) || initialDataSiswa;
        let dataAbsensi = JSON.parse(localStorage.getItem('dataAbsensi')) || {};
        let dataNilai = JSON.parse(localStorage.getItem('dataNilai')) || {};
        let dataMateri = JSON.parse(localStorage.getItem('dataMateri')) || {};
        let dataRpp = JSON.parse(localStorage.getItem('dataRpp')) || [];
        let dataJadwal = JSON.parse(localStorage.getItem('dataJadwal')) || {};
        let dataArsip = JSON.parse(localStorage.getItem('dataArsip')) || [{id: 1, name: "Contoh Dokumen Kurikulum", link: "https://docs.google.com/document/d/123456789"}, {id: 2, name: "Materi Pembelajaran Bab 2", link: "https://docs.google.com/presentation/d/987654321"}];
        let dataKalender = JSON.parse(localStorage.getItem('dataKalender')) || {};
        let dataProfil = JSON.parse(localStorage.getItem('dataProfil')) || {
            sekolah: {
                nama: "SMKS JAYA",
                alamat: "Jl. Pangsor Sinaresmi Palabuhanratu",
                kepsek: "Andriyana, S.Pd.I. "
            },
            guru: {
                nama: "D. Ervan Fauzan, S.Sos, Gr.",
                nip: "198012012005011001",
                bidang: "Pendidikan Pancasila"
            }
        };
        let dataAgenda = JSON.parse(localStorage.getItem('dataAgenda')) || [];
        let dataCatatanSiswa = JSON.parse(localStorage.getItem('dataCatatanSiswa')) || {};

        let kehadiranChart;
        let currentAdministrasiSubMenu = 'jadwal';
        let jadwalHistory = []; // For undo functionality

        // --- Sidebar and Navigation ---
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                button.classList.add('text-gray-600', 'hover:bg-gray-100');
            });
            
            const activeContent = document.getElementById(`content-${tabName}`);
            const activeButton = document.getElementById(`tab-${tabName}`);
            activeContent.classList.remove('hidden');
            activeButton.classList.add('bg-blue-600', 'text-white', 'shadow-md');
            activeContent.classList.add('fade-in');

            loadTabContent(tabName);

            if (window.innerWidth < 768) {
                toggleSidebar();
            }
        }

        // --- Perbaikan Utama: Logika pemuatan konten tab diperbaiki ---
        function loadTabContent(tabName) {
            const container = document.getElementById(`content-${tabName}`);
            if (!container) return;
            
            const isContentLoaded = container.innerHTML.trim() !== '';
            const dynamicTabs = ['dashboard', 'manajemen', 'rekap', 'administrasi', 'setting'];
            if (isContentLoaded && !dynamicTabs.includes(tabName)) {
                 return;
            }

            let html = '';
            switch(tabName) {
                case 'dashboard':
                    html = `<div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800 mb-2">Dashboard Statistik</h2>
                                <p class="text-gray-600">Ringkasan visual kehadiran dan nilai</p>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 border-b-2 border-gray-100 mb-6">
                            <button onclick="switchDashboardSubMenu('kelas')" id="sub-dashboard-kelas" class="px-4 py-2 rounded-t-lg font-medium">Statistik Keseluruhan Kelas</button>
                            <button onclick="switchDashboardSubMenu('siswa')" id="sub-dashboard-siswa" class="px-4 py-2 rounded-t-lg font-medium">Statistik Individu Siswa</button>
                        </div>
                        
                        <div id="dashboard-sub-content"></div>
                    </div>`;
                    break;
                case 'rekap':
                    html = `<div class="bg-white rounded-2xl shadow-xl p-6">
                        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800 mb-2">Rekap Kehadiran & Laporan</h2>
                                <p class="text-gray-600">Lihat statistik kehadiran, nilai, dan cetak laporan</p>
                            </div>
                            <div class="flex flex-col md:flex-row gap-3">
                                <div class="flex flex-col">
                                    <label for="rekapStartDate" class="text-sm text-gray-600">Dari Tanggal:</label>
                                    <input type="date" id="rekapStartDate" class="px-4 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div class="flex flex-col">
                                    <label for="rekapEndDate" class="text-sm text-gray-600">Sampai Tanggal:</label>
                                    <input type="date" id="rekapEndDate" class="px-4 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div class="flex flex-col">
                                    <label class="text-sm text-gray-600 invisible">.</label>
                                    <select id="rekapKelas" class="h-10 px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="">Pilih Kelas</option>
                                    </select>
                                </div>
                                <div class="flex flex-col">
                                    <label for="rekapSearch" class="text-sm text-gray-600">Cari Siswa:</label>
                                    <input type="text" id="rekapSearch" placeholder="Cari nama..." class="h-10 px-4 py-2 border rounded-lg">
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-4 justify-end mb-6">
                            <button onclick="cetakLaporan()" class="h-10 bg-purple-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-purple-600 transition-colors">🖨️ Cetak Laporan</button>
                            <button onclick="exportToExcel()" class="h-10 bg-teal-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-teal-600 transition-colors">📥 Export Excel</button>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl border"><p class="text-green-600 text-sm font-medium">Total Hadir</p><p id="totalHadir" class="text-2xl font-bold text-green-700">0</p></div>
                            <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-4 rounded-xl border"><p class="text-yellow-600 text-sm font-medium">Total Sakit</p><p id="totalSakit" class="text-2xl font-bold text-yellow-700">0</p></div>
                            <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border"><p class="text-blue-600 text-sm font-medium">Total Izin</p><p id="totalIzin" class="text-2xl font-bold text-blue-700">0</p></div>
                            <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-xl border"><p class="text-red-600 text-sm font-medium">Total Alpa</p><p id="totalAlpa" class="text-2xl font-bold text-red-700">0</p></div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 mt-6 mb-4">Rekapitulasi Kehadiran Per Siswa</h3>
                        <div class="overflow-x-auto mb-8">
                            <table class="w-full border-collapse bg-white rounded-lg overflow-hidden shadow-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-3 text-left text-sm font-medium">No</th>
                                        <th class="p-3 text-left text-sm font-medium">Nama</th>
                                        <th class="p-3 text-center text-sm font-medium">H</th>
                                        <th class="p-3 text-center text-sm font-medium">S</th>
                                        <th class="p-3 text-center text-sm font-medium">I</th>
                                        <th class="p-3 text-center text-sm font-medium">A</th>
                                        <th class="p-3 text-center text-sm font-medium">%</th>
                                    </tr>
                                </thead>
                                <tbody id="rekapTable"></tbody>
                            </table>
                        </div>
                        <div id="laporanPreview" class="border rounded-lg p-6 bg-gray-50 mt-8">
                            <div class="text-center text-gray-500 py-8">
                                <div class="text-4xl mb-3">📄</div>
                                <p>Pilih kelas dan rentang tanggal untuk preview laporan</p>
                            </div>
                        </div>
                    </div>`;
                    break;
                case 'manajemen':
                    html = `<div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Manajemen Siswa</h2>
                        <p class="text-gray-600 mb-4">Tambahkan, edit, atau hapus data siswa.</p>
                        <div class="bg-gray-50 p-6 rounded-xl border mb-6">
                            <h3 class="text-xl font-semibold mb-4">Tambah Siswa Baru</h3>
                            <form id="addStudentForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                                <div>
                                    <label for="newKelas" class="block text-sm font-medium">Kelas</label>
                                    <select id="newKelas" name="kelas" class="mt-1 block w-full p-2 border rounded-md"></select>
                                </div>
                                <div>
                                    <label for="newNama" class="block text-sm font-medium">Nama Siswa</label>
                                    <input type="text" id="newNama" name="nama" class="mt-1 block w-full p-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="newJk" class="block text-sm font-medium">Jenis Kelamin</label>
                                    <select id="newJk" name="jk" class="mt-1 block w-full p-2 border rounded-md" required>
                                        <option value="">Pilih</option>
                                        <option value="L">Laki-laki</option>
                                        <option value="P">Perempuan</option>
                                    </select>
                                </div>
                                <button type="submit" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-medium">➕ Tambah Siswa</button>
                            </form>
                        </div>
                        <div class="mt-6">
                            <h3 class="text-xl font-semibold mb-4">Daftar Siswa Per Kelas</h3>
                            <select id="manajemenKelas" class="px-4 py-2 border rounded-lg mb-4">
                                <option value="">Pilih Kelas untuk Manajemen</option>
                            </select>
                            <div id="manajemenTableContainer" class="overflow-x-auto">
                                <div class="text-center text-gray-500 py-8">
                                    <div class="text-4xl mb-3">🧑‍🎓</div>
                                    <p>Pilih kelas untuk mengelola data siswa</p>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    break;
                case 'administrasi':
                    // Memuat konten sub-menu administrasi secara dinamis
                    loadAdministrasiTabContent(currentAdministrasiSubMenu);
                    return; 
                case 'setting':
                    html = `<div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Pengaturan Sistem</h2>
                        
                        <div class="bg-gray-50 p-6 rounded-xl border mb-6">
                            <h3 class="text-xl font-semibold mb-2">Tentang Sistem</h3>
                            <p class="text-gray-600 mb-4">Sistem Informasi Manajemen Guru (SIM G) ini dirancang untuk membantu guru mengelola absensi, nilai, dan administrasi pembelajaran secara digital. Semua data disimpan secara lokal di browser Anda. Anda bisa mencadangkan data ke file JSON dan memulihkannya kapan saja.</p>
                        </div>

                        <div class="bg-gray-50 p-6 rounded-xl border mb-6">
                            <h3 class="text-xl font-semibold mb-2">Manajemen Data Keseluruhan</h3>
                            <p class="text-gray-600 mb-4">Cadangkan atau pulihkan semua data (siswa, absensi, nilai, RPP, jadwal, dll.) dalam satu file.</p>
                            <div class="flex flex-col md:flex-row gap-4 items-center">
                                <button onclick="exportData()" class="bg-teal-500 text-white px-6 py-3 rounded-lg font-medium">📥 Ekspor Semua Data</button>
                                <div class="flex items-center gap-2 flex-wrap">
                                    <label for="importFile" class="bg-indigo-500 text-white px-6 py-3 rounded-lg font-medium cursor-pointer">📂 Pilih File Impor</label>
                                    <input type="file" id="importFile" accept="application/json" class="hidden">
                                    <span id="fileName" class="text-gray-600"></span>
                                    <button onclick="importData()" class="bg-indigo-500 text-white px-6 py-3 rounded-lg font-medium">📤 Impor Data</button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-red-50 p-6 rounded-xl border-2 border-red-300">
                            <h3 class="text-xl font-semibold mb-2 text-red-700">Opsi Reset Data Keseluruhan</h3>
                            <p class="text-red-600 mb-4">⚠️ Peringatan keras: Mengklik tombol ini akan menghapus SEMUA data siswa, absensi, nilai, RPP, dan jadwal secara PERMANEN. Tindakan ini tidak dapat dibatalkan.</p>
                            <button onclick="resetAllDataConfirmation()" class="bg-red-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-red-700 transition-colors">🗑️ Hapus Semua Data</button>
                        </div>
                        
                        <div class="mt-8 pt-8 border-t-2">
                             <h3 class="text-xl font-semibold mb-2">Dukungan Sistem & Donasi</h3>
                             <p class="text-gray-600 mb-4">Jika Anda mengalami kendala atau ingin memberikan masukan, silakan hubungi kami.</p>
                             <div class="flex flex-col md:flex-row gap-4 items-start">
                                <a href="https://wa.me/6282112121707" target="_blank" class="bg-green-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-600 transition-colors flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 448 512" fill="white"><path d="M380.9 97.1C339.1 55.4 286.5 32 229.8 32c-56.6 0-109.2 23.4-151 64.9C37.1 138.8 21.8 191 21.8 256c0 55.2 11.2 107.5 33.3 151.7l-29 105.7c-2.4 8.7 5.7 16.5 14.4 14.4l105.7-29c44.2 22.1 96.5 33.3 151.7 33.3c56.7 0 109.3-23.4 151.1-64.9C432.9 373.2 448 321 448 256c0-55.2-11.2-107.5-33.3-151.7zm-99.7 202.9c-2.7 5-7.7 9-11.5 13.9-3.8 4.9-7.8 9.7-11.9 14.5-3.6 4.2-7 8.3-10.4 12.3-4.1 4.9-8.4 9.6-12.7 14.2-3.8 4-7.8 7.7-11.6 11.4-5.3 5.3-11.3 9.4-17.6 12.7-6.2 3.3-12.8 5.7-19.4 6.9-6.3 1.2-13 1.6-19.5 0-6.6-1.5-12.9-4.3-18.7-8.5-5.3-3.7-10.4-8-15.1-12.7-4.3-4.2-8.4-8.7-12.3-13.4-3.6-4.5-7.1-8.9-10.4-13.4-3.8-4.9-7.8-9.6-11.5-14.5-2.7-5-7.7-9-11.5-13.9-1.3-1.6-2.5-3.3-3.7-5-1.1-1.3-2.2-2.7-3.3-4.1-1-1.4-2.1-2.9-3.1-4.4-1.1-1.5-2.1-3-3.1-4.6-1.5-2.6-2.9-5.1-4.2-7.8-1.5-2.8-3-5.5-4.4-8.3-1.2-2.5-2.5-5.1-3.6-7.7-1.1-2.5-2.2-5.1-3.1-7.7-1-2.5-1.9-5-2.7-7.6-1.1-3.4-2.1-6.9-2.7-10.3-.6-3.4-1.2-6.8-1.2-10.2 0-14.8 5.8-28.7 15.6-38.5 9.8-9.8 23.7-15.6 38.5-15.6 14.8 0 28.7 5.8 38.5 15.6 9.8 9.8 15.6 23.7 15.6 38.5 0 3.4-.6 6.8-1.2 10.2-.8 3.4-1.7 6.9-2.7 10.3-1 2.5-2.1 5.1-3.1 7.7-1.1 2.5-2.4 5.1-3.6 7.7-1.4 2.8-2.9 5.5-4.4 8.3-1.5 2.6-2.9 5.1-4.2 7.8-1.1 1.5-2.1 3-3.1 4.6-1 1.4-2.1 2.9-3.3 4.1-1.2 1.6-2.5 3.3-3.7 5z"/></svg>
                                    Hubungi Kami (WhatsApp)
                                </a>
                                <a href="https://link.dana.id/minta?full_url=https://qr.dana.id/v1/281012012024041300956460" target="_blank" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center gap-2">
                                    <img src="https://placehold.co/20x20/ffffff/000000?text=DANA" alt="Logo DANA" class="w-5 h-5">
                                    Donasi (DANA)
                                </a>
                            </div>
                        </div>
                    </div>`;
                    break;
            }

            // Masukkan HTML ke dalam kontainer
            if (html) {
                container.innerHTML = html;
            }
            
            // Lampirkan event listener SETELAH HTML dimuat
            if (tabName === 'dashboard') {
                 // Menambahkan event listener untuk dropdown kelas dan siswa di dashboard
                 
                 // Panggil fungsi untuk merender sub-menu dan konten
                 renderDashboardSubMenu();

                 // Inisialisasi tampilan default
                 updateDashboard();
            } else if (tabName === 'rekap') {
                const rekapKelas = document.getElementById('rekapKelas');
                const rekapStartDate = document.getElementById('rekapStartDate');
                const rekapEndDate = document.getElementById('rekapEndDate');
                const rekapSearch = document.getElementById('rekapSearch');
                if (rekapKelas) rekapKelas.addEventListener('input', updateRekap);
                if (rekapStartDate) rekapStartDate.addEventListener('input', updateRekap);
                if (rekapEndDate) rekapEndDate.addEventListener('input', updateRekap);
                if (rekapSearch) rekapSearch.addEventListener('input', updateRekap);
                setInitialDates(); 
                updateSelectOptions(); 
                updateRekap();
            } else if (tabName === 'manajemen') {
                const addStudentForm = document.getElementById('addStudentForm');
                const manajemenKelasSelect = document.getElementById('manajemenKelas');
                if (addStudentForm) addStudentForm.addEventListener('submit', addStudent);
                if (manajemenKelasSelect) manajemenKelasSelect.addEventListener('change', (e) => updateManajemenTable(e.target.value));
                updateSelectOptions();
            } else if (tabName === 'setting') {
                const importFile = document.getElementById('importFile');
                if (importFile) {
                    importFile.addEventListener('change', (e) => {
                        const fileNameEl = document.getElementById('fileName');
                        if (fileNameEl) {
                             fileNameEl.textContent = e.target.files.length > 0 ? e.target.files[0].name : '';
                        }
                    });
                }
            }
        }
        
        // State untuk dashboard
        let currentDashboardSubMenu = 'kelas';

        // Fungsi untuk merender sub-menu dashboard
        function renderDashboardSubMenu() {
            const container = document.getElementById('dashboard-sub-content');
            if (!container) return;
            container.innerHTML = ''; // Clear previous content

            if (currentDashboardSubMenu === 'kelas') {
                container.innerHTML = `
                    <div class="flex flex-wrap gap-3 items-center mb-6">
                        <select id="dashboardKelas" class="px-4 py-2 border rounded-lg">
                            <option value="">Pilih Kelas</option>
                        </select>
                    </div>
                    <div id="dashboardStatsContent" class="space-y-6">
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-3">📈</div>
                            <p>Pilih kelas untuk menampilkan statistik kelas.</p>
                        </div>
                    </div>
                `;
                 document.getElementById('dashboardKelas')?.addEventListener('change', updateDashboard);
            } else if (currentDashboardSubMenu === 'siswa') {
                container.innerHTML = `
                    <div class="flex flex-wrap gap-3 items-center mb-6">
                        <select id="dashboardKelas" class="px-4 py-2 border rounded-lg">
                            <option value="">Pilih Kelas</option>
                        </select>
                        <select id="dashboardSiswa" class="px-4 py-2 border rounded-lg" disabled>
                            <option value="">Pilih Siswa</option>
                        </select>
                    </div>
                    <div id="dashboardStatsContent" class="space-y-6">
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-3">🧑‍🎓</div>
                            <p>Pilih kelas dan siswa untuk menampilkan detail individu.</p>
                        </div>
                    </div>
                `;
                document.getElementById('dashboardKelas')?.addEventListener('change', updateDashboard);
                document.getElementById('dashboardSiswa')?.addEventListener('change', updateDashboard);
            }

            // Perbarui opsi dropdown
            updateSelectOptions();
            
            // Setel kelas aktif dari dropdown
            const kelasSelect = document.getElementById('dashboardKelas');
            const kelas = localStorage.getItem('lastDashboardKelas');
            if (kelas && kelasSelect && kelasSelect.querySelector(`option[value="${kelas}"]`)) {
                 kelasSelect.value = kelas;
            }
            
            // Perbarui tombol sub-menu
            document.querySelectorAll('#content-dashboard .rounded-t-lg').forEach(button => {
                button.classList.remove('bg-blue-600', 'text-white');
                button.classList.add('text-gray-600', 'hover:bg-gray-100');
            });
            const subMenuButton = document.getElementById(`sub-dashboard-${currentDashboardSubMenu}`);
            if (subMenuButton) {
                subMenuButton.classList.add('bg-blue-600', 'text-white');
                subMenuButton.classList.remove('text-gray-600', 'hover:bg-gray-100');
            }
        }

        // Fungsi untuk beralih antar sub-menu dashboard
        function switchDashboardSubMenu(subMenuName) {
            currentDashboardSubMenu = subMenuName;
            renderDashboardSubMenu();
            updateDashboard();
        }

        // Fungsi untuk memuat konten sub-menu Administrasi
        function loadAdministrasiTabContent(subMenuName) {
            const container = document.getElementById('content-administrasi');
            let html = `
                <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Administrasi Guru</h2>
                    <nav class="flex flex-wrap gap-2 border-b-2 border-gray-100 mb-6">
                        <button onclick="switchAdministrasiSubMenu('jadwal')" id="sub-jadwal" class="px-4 py-2 rounded-t-lg font-medium">Jadwal & Kalender</button>
                        <button onclick="switchAdministrasiSubMenu('agenda')" id="sub-agenda" class="px-4 py-2 rounded-t-lg font-medium">Agenda Guru</button>
                        <button onclick="switchAdministrasiSubMenu('catatan')" id="sub-catatan" class="px-4 py-2 rounded-t-lg font-medium">Catatan Siswa</button>
                        <button onclick="switchAdministrasiSubMenu('arsip')" id="sub-arsip" class="px-4 py-2 rounded-t-lg font-medium">Arsip & Dokumentasi</button>
                        <button onclick="switchAdministrasiSubMenu('biodata')" id="sub-biodata" class="px-4 py-2 rounded-t-lg font-medium">Biodata & Profil</button>
                        <button onclick="switchAdministrasiSubMenu('laporan')" id="sub-laporan" class="px-4 py-2 rounded-t-lg font-medium">Report Administrasi Guru</button>
                    </nav>
                    <div id="administrasi-content"></div>
                </div>
            `;
            if (container) container.innerHTML = html;
            switchAdministrasiSubMenu(subMenuName);
        }
        
        // Fungsi untuk beralih antar sub-menu Administrasi
        function switchAdministrasiSubMenu(subMenuName) {
            currentAdministrasiSubMenu = subMenuName;
            document.querySelectorAll('#content-administrasi .rounded-t-lg').forEach(button => {
                button.classList.remove('bg-blue-600', 'text-white');
                button.classList.add('text-gray-600', 'hover:bg-gray-100');
            });
            const selectedButton = document.getElementById(`sub-${subMenuName}`);
            if (selectedButton) {
                selectedButton.classList.add('bg-blue-600', 'text-white');
                selectedButton.classList.remove('text-gray-600', 'hover:bg-gray-100');
            }

            const subContainer = document.getElementById('administrasi-content');
            if (subContainer) {
                subContainer.innerHTML = '';
                subContainer.classList.add('fade-in');
            }

            switch(subMenuName) {
                case 'jadwal':
                    renderJadwalKalender();
                    break;
                case 'agenda':
                    renderAgendaGuru();
                    break;
                case 'catatan':
                    renderCatatanSiswa();
                    break;
                case 'arsip':
                    renderArsipDokumentasi();
                    break;
                case 'biodata':
                    renderBiodataProfile();
                    break;
                case 'laporan':
                    renderLaporanAdministrasi();
                    break;
            }
        }

        // Fungsi untuk menampilkan konten Agenda Guru
        function renderAgendaGuru() {
            const subContainer = document.getElementById('administrasi-content');
            if (!subContainer) return;
            let html = `
                <h3 class="text-xl font-semibold mb-4">Agenda Kegiatan Guru</h3>
                <p class="text-gray-600 mb-4">Catat semua kegiatan penting Anda di sini.</p>
                <div class="bg-gray-50 p-6 rounded-xl border mb-6">
                    <h4 class="text-lg font-medium mb-4">Tambah Agenda Baru</h4>
                    <form id="agendaForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-1">
                            <label for="agendaDate" class="block text-sm font-medium">Tanggal</label>
                            <input type="date" id="agendaDate" class="mt-1 block w-full p-2 border rounded-md" required>
                        </div>
                        <div class="md:col-span-1">
                            <label for="agendaTime" class="block text-sm font-medium">Waktu</label>
                            <input type="time" id="agendaTime" class="mt-1 block w-full p-2 border rounded-md" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="agendaKegiatan" class="block text-sm font-medium">Kegiatan</label>
                            <input type="text" id="agendaKegiatan" placeholder="Contoh: Rapat Wali Kelas" class="mt-1 block w-full p-2 border rounded-md" required>
                        </div>
                        <button type="submit" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-medium col-span-full">➕ Simpan Agenda</button>
                    </form>
                </div>
                <div class="mt-6">
                    <h4 class="text-xl font-semibold mb-4">Daftar Agenda</h4>
                    <div id="agendaList" class="space-y-4"></div>
                </div>
            `;
            subContainer.innerHTML = html;
            document.getElementById('agendaForm').addEventListener('submit', saveAgenda);
            updateAgendaList();
            setInitialDates();
        }

        // Fungsi untuk menyimpan agenda
        function saveAgenda(event) {
            event.preventDefault();
            const form = event.target;
            const newAgenda = {
                id: Date.now(),
                date: form.agendaDate.value,
                time: form.agendaTime.value,
                kegiatan: form.agendaKegiatan.value
            };

            if (newAgenda.date && newAgenda.time && newAgenda.kegiatan) {
                dataAgenda.push(newAgenda);
                localStorage.setItem('dataAgenda', JSON.stringify(dataAgenda));
                showNotification('✅ Agenda berhasil disimpan!', 'success');
                form.reset();
                updateAgendaList();
            } else {
                showNotification('⚠️ Harap lengkapi semua data!', 'warning');
            }
        }
        
        // Fungsi untuk memperbarui daftar agenda
        function updateAgendaList() {
            const listContainer = document.getElementById('agendaList');
            if (!listContainer) return;
            if (dataAgenda.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-500 py-8">Belum ada agenda tersimpan.</p>`;
                return;
            }
            const sortedAgenda = [...dataAgenda].sort((a, b) => {
                const dateA = new Date(`${a.date}T${a.time}`);
                const dateB = new Date(`${b.date}T${b.time}`);
                return dateA - dateB;
            });

            listContainer.innerHTML = sortedAgenda.map(agenda => `
                <div class="bg-gray-100 p-4 rounded-xl border flex items-center justify-between flex-wrap gap-2">
                    <div>
                        <p class="font-semibold text-gray-800">${agenda.kegiatan}</p>
                        <p class="text-sm text-gray-500">Tanggal: ${new Date(agenda.date).toLocaleDateString('id-ID')}, Waktu: ${agenda.time}</p>
                    </div>
                    <div class="flex gap-2 shrink-0">
                        <button onclick="promptEditAgenda(${agenda.id})" class="p-2 rounded-md bg-blue-500 text-white hover:bg-blue-600 transition-colors">✏️ Edit</button>
                        <button onclick="deleteAgenda(${agenda.id})" class="p-2 rounded-md bg-red-500 text-white hover:bg-red-600 transition-colors">🗑️ Hapus</button>
                    </div>
                </div>
            `).join('');
        }

        // Fungsi untuk menampilkan modal edit agenda
        function promptEditAgenda(id) {
            const agenda = dataAgenda.find(a => a.id === id);
            if (!agenda) return;
            const bodyHtml = `
                <label class="block text-sm font-medium">Tanggal</label>
                <input type="date" id="modal-agenda-date" class="mt-1 block w-full p-2 border rounded-md" value="${agenda.date}">
                <label class="block text-sm font-medium mt-4">Waktu</label>
                <input type="time" id="modal-agenda-time" class="mt-1 block w-full p-2 border rounded-md" value="${agenda.time}">
                <label class="block text-sm font-medium mt-4">Kegiatan</label>
                <input type="text" id="modal-agenda-kegiatan" class="mt-1 block w-full p-2 border rounded-md" value="${agenda.kegiatan}">
            `;
            showModalWithInputs('Edit Agenda', bodyHtml, () => {
                const newDate = document.getElementById('modal-agenda-date').value;
                const newTime = document.getElementById('modal-agenda-time').value;
                const newKegiatan = document.getElementById('modal-agenda-kegiatan').value;
                if (newDate && newTime && newKegiatan) {
                    const agendaIndex = dataAgenda.findIndex(a => a.id === id);
                    if (agendaIndex !== -1) {
                        dataAgenda[agendaIndex] = { ...agenda, date: newDate, time: newTime, kegiatan: newKegiatan };
                        localStorage.setItem('dataAgenda', JSON.stringify(dataAgenda));
                        showNotification('✅ Agenda berhasil diperbarui!', 'success');
                        updateAgendaList();
                    }
                } else {
                    showNotification('⚠️ Harap lengkapi semua data!', 'warning');
                }
            });
        }

        // Fungsi untuk menghapus agenda
        function deleteAgenda(id) {
            showModal('Konfirmasi Hapus', 'Yakin ingin menghapus agenda ini?', () => {
                dataAgenda = dataAgenda.filter(a => a.id !== id);
                localStorage.setItem('dataAgenda', JSON.stringify(dataAgenda));
                showNotification('🗑️ Agenda berhasil dihapus!', 'info');
                updateAgendaList();
            });
        }
        
        // Fungsi untuk menampilkan konten Catatan Siswa
        function renderCatatanSiswa() {
            const subContainer = document.getElementById('administrasi-content');
            if (!subContainer) return;

            let kelasOptions = Object.keys(dataSiswa).sort().map(k => `<option value="${k}">${k}</option>`).join('');

            let html = `
                <h3 class="text-xl font-semibold mb-4">Catatan Siswa</h3>
                <p class="text-gray-600 mb-4">Buat catatan khusus untuk siswa tertentu.</p>
                <div class="bg-gray-50 p-6 rounded-xl border mb-6">
                    <h4 class="text-lg font-medium mb-4">Formulir Catatan</h4>
                    <form id="catatanForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-1">
                            <label for="catatanKelas" class="block text-sm font-medium">Pilih Kelas</label>
                            <select id="catatanKelas" class="mt-1 block w-full p-2 border rounded-md" required>
                                <option value="">Pilih Kelas</option>
                                ${kelasOptions}
                            </select>
                        </div>
                        <div class="md:col-span-1">
                            <label for="catatanSiswa" class="block text-sm font-medium">Pilih Siswa</label>
                            <select id="catatanSiswa" class="mt-1 block w-full p-2 border rounded-md" required disabled>
                                <option value="">Pilih Siswa</option>
                            </select>
                        </div>
                        <div class="lg:col-span-2 md:col-span-2">
                             <label for="catatanText" class="block text-sm font-medium">Isi Catatan</label>
                             <textarea id="catatanText" rows="3" class="mt-1 block w-full p-2 border rounded-md" placeholder="Tulis catatan di sini..." required></textarea>
                        </div>
                        <div class="col-span-full flex gap-3">
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-medium">💾 Simpan Catatan</button>
                            <button type="button" onclick="resetCatatanForm()" class="bg-gray-200 text-gray-800 px-6 py-2.5 rounded-lg font-medium">🔄 Reset</button>
                        </div>
                    </form>
                </div>
                <div class="mt-6">
                    <h4 class="text-xl font-semibold mb-4">Daftar Catatan Siswa</h4>
                    <div id="catatanList" class="space-y-4"></div>
                </div>
            `;
            subContainer.innerHTML = html;
            document.getElementById('catatanKelas').addEventListener('change', updateSiswaDropdown);
            document.getElementById('catatanSiswa').addEventListener('change', updateCatatanList);
            document.getElementById('catatanForm').addEventListener('submit', saveCatatan);
        }

        // Fungsi untuk memperbarui dropdown siswa berdasarkan kelas
        function updateSiswaDropdown() {
            const kelas = document.getElementById('catatanKelas').value;
            const siswaSelect = document.getElementById('catatanSiswa');
            siswaSelect.innerHTML = `<option value="">Pilih Siswa</option>`;
            if (kelas && dataSiswa[kelas]) {
                dataSiswa[kelas].sort((a,b) => a.nama.localeCompare(b.nama)).forEach(siswa => {
                    siswaSelect.innerHTML += `<option value="${siswa.nis}">${siswa.nama}</option>`;
                });
                siswaSelect.disabled = false;
            } else {
                siswaSelect.disabled = true;
            }
            updateCatatanList();
        }

        // Fungsi untuk menyimpan catatan siswa
        function saveCatatan(event) {
            event.preventDefault();
            const kelas = document.getElementById('catatanKelas').value;
            const nis = document.getElementById('catatanSiswa').value;
            const catatan = document.getElementById('catatanText').value.trim();

            if (kelas && nis && catatan) {
                const key = `${kelas}_${nis}`;
                if (!dataCatatanSiswa[key]) {
                    dataCatatanSiswa[key] = [];
                }
                dataCatatanSiswa[key].push({
                    id: Date.now(),
                    text: catatan,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('dataCatatanSiswa', JSON.stringify(dataCatatanSiswa));
                showNotification('✅ Catatan berhasil disimpan!', 'success');
                document.getElementById('catatanText').value = '';
                updateCatatanList();
            } else {
                showNotification('⚠️ Harap lengkapi semua kolom!', 'warning');
            }
        }
        
        // Fungsi untuk mereset formulir catatan
        function resetCatatanForm() {
            document.getElementById('catatanForm').reset();
            const siswaSelect = document.getElementById('catatanSiswa');
            siswaSelect.innerHTML = `<option value="">Pilih Siswa</option>`;
            siswaSelect.disabled = true;
            document.getElementById('catatanList').innerHTML = '';
        }

        // Fungsi untuk memperbarui daftar catatan siswa
        function updateCatatanList() {
            const listContainer = document.getElementById('catatanList');
            const kelas = document.getElementById('catatanKelas').value;
            const nis = document.getElementById('catatanSiswa').value;

            if (!listContainer) return;

            if (!kelas || !nis || !dataCatatanSiswa[`${kelas}_${nis}`]) {
                listContainer.innerHTML = `<p class="text-center text-gray-500 py-8">Belum ada catatan untuk siswa ini.</p>`;
                return;
            }
            const catatanSiswa = dataCatatanSiswa[`${kelas}_${nis}`];

            const sortedCatatan = [...catatanSiswa].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            listContainer.innerHTML = sortedCatatan.map(catatan => `
                <div class="bg-gray-100 p-4 rounded-xl border flex items-start justify-between flex-wrap gap-2">
                    <div>
                        <p class="text-gray-800">${catatan.text}</p>
                        <p class="text-sm text-gray-500 mt-1">Dibuat pada: ${new Date(catatan.timestamp).toLocaleString('id-ID')}</p>
                    </div>
                    <div class="flex gap-2 shrink-0">
                        <button onclick="promptEditCatatan('${kelas}', '${nis}', ${catatan.id})" class="p-2 rounded-md bg-blue-500 text-white hover:bg-blue-600 transition-colors">✏️ Edit</button>
                        <button onclick="deleteCatatan('${kelas}', '${nis}', ${catatan.id})" class="p-2 rounded-md bg-red-500 text-white hover:bg-red-600 transition-colors">🗑️ Hapus</button>
                    </div>
                </div>
            `).join('');
        }

        // Fungsi untuk mengedit catatan siswa
        function promptEditCatatan(kelas, nis, id) {
            const catatan = dataCatatanSiswa[`${kelas}_${nis}`].find(c => c.id === id);
            if (!catatan) return;

            const bodyHtml = `
                <p>Edit catatan untuk siswa ini:</p>
                <textarea id="modal-catatan-edit" rows="4" class="w-full p-2 border rounded-md mt-2">${catatan.text}</textarea>
            `;
            showModalWithInputs('Edit Catatan', bodyHtml, () => {
                const newText = document.getElementById('modal-catatan-edit').value.trim();
                if (newText) {
                    const catatanIndex = dataCatatanSiswa[`${kelas}_${nis}`].findIndex(c => c.id === id);
                    if (catatanIndex !== -1) {
                        dataCatatanSiswa[`${kelas}_${nis}`][catatanIndex].text = newText;
                        dataCatatanSiswa[`${kelas}_${nis}`][catatanIndex].timestamp = new Date().toISOString(); // Update timestamp
                        localStorage.setItem('dataCatatanSiswa', JSON.stringify(dataCatatanSiswa));
                        showNotification('✅ Catatan berhasil diperbarui!', 'success');
                        updateCatatanList();
                    }
                } else {
                    showNotification('⚠️ Catatan tidak boleh kosong!', 'warning');
                }
            });
        }
        
        // Fungsi untuk menghapus catatan siswa
        function deleteCatatan(kelas, nis, id) {
            showModal('Konfirmasi Hapus', 'Yakin ingin menghapus catatan ini?', () => {
                if (dataCatatanSiswa[`${kelas}_${nis}`]) {
                    dataCatatanSiswa[`${kelas}_${nis}`] = dataCatatanSiswa[`${kelas}_${nis}`].filter(c => c.id !== id);
                    if (dataCatatanSiswa[`${kelas}_${nis}`].length === 0) {
                        delete dataCatatanSiswa[`${kelas}_${nis}`];
                    }
                    localStorage.setItem('dataCatatanSiswa', JSON.stringify(dataCatatanSiswa));
                    showNotification('🗑️ Catatan berhasil dihapus!', 'info');
                    updateCatatanList();
                }
            });
        }

        // Fungsi untuk menampilkan konten Jadwal & Kalender
        function renderJadwalKalender() {
            const subContainer = document.getElementById('administrasi-content');
            if (!subContainer) return;
            const jadwalDays = ['senin', 'selasa', 'rabu', 'kamis', 'jumat'];
            const jadwalList = jadwalDays.map(day => {
                const dayTitle = day.charAt(0).toUpperCase() + day.slice(1);
                const scheduleItems = dataJadwal[day] || [];
                const schedule = scheduleItems.map((item, index) => `
                    <div class="bg-white p-3 rounded-lg border flex justify-between items-center gap-2">
                        <div>
                            <p class="font-semibold">${item.time}</p>
                            <p class="text-sm text-gray-600">${item.subject} - ${item.kelas}</p>
                        </div>
                        <button onclick="deleteJadwal('${day}', ${index})" class="text-red-600 hover:text-red-800 shrink-0">🗑️ Hapus</button>
                    </div>
                `).join('');
                return `
                    <div class="p-4 rounded-xl border bg-gray-50">
                        <h4 class="font-bold text-lg mb-3">${dayTitle}</h4>
                        <div class="space-y-2">${schedule || 'Tidak ada jadwal.'}</div>
                    </div>
                `;
            }).join('');

            let html = `
                <h3 class="text-xl font-semibold mb-4">Jadwal Mengajar & Kalender</h3>
                <div class="bg-gray-50 p-6 rounded-xl border mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-medium">Input Jadwal Mengajar</h4>
                        <button onclick="undoJadwal()" id="undoJadwalBtn" class="bg-yellow-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-yellow-600 transition-colors" disabled>↩️ Undo</button>
                    </div>
                    <form id="jadwalForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <select id="jadwalHari" class="w-full p-2 border rounded-md" required>
                            <option value="">Pilih Hari</option>
                            <option value="senin">Senin</option>
                            <option value="selasa">Selasa</option>
                            <option value="rabu">Rabu</option>
                            <option value="kamis">Kamis</option>
                            <option value="jumat">Jumat</option>
                        </select>
                        <input type="time" id="jadwalWaktu" class="w-full p-2 border rounded-md" required>
                        <input type="text" id="jadwalPelajaran" placeholder="Mata Pelajaran" class="w-full p-2 border rounded-md" required>
                        <select id="jadwalKelas" class="w-full p-2 border rounded-md" required>
                             <option value="">Pilih Kelas</option>
                             ${Object.keys(dataSiswa).sort().map(k => `<option value="${k}">${k}</option>`).join('')}
                        </select>
                        <button type="submit" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-medium col-span-1 md:col-span-2">➕ Tambah Jadwal</button>
                    </form>
                </div>

                <div class="mt-6">
                    <h4 class="text-xl font-semibold mb-4">Jadwal Mengajar Anda</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${jadwalList}
                    </div>
                </div>

                <div class="mt-8 pt-8 border-t">
                    <h4 class="text-xl font-semibold mb-4">Kalender Akademik</h4>
                    <div class="grid grid-cols-7 gap-1 text-center font-bold text-gray-600 mb-2">
                        <span>Min</span><span>Sen</span><span>Sel</span><span>Rab</span><span>Kam</span><span>Jum</span><span>Sab</span>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1"></div>
                </div>
            `;
            subContainer.innerHTML = html;
            document.getElementById('jadwalForm').addEventListener('submit', saveJadwal);
            updateJadwalUndoButton();
            renderCalendar();
        }

        // Fungsi untuk menyimpan data Jadwal
        function saveJadwal(event) {
            event.preventDefault();
            const form = event.target;
            const day = form.jadwalHari.value;
            const newJadwal = {
                id: Date.now(),
                time: form.jadwalWaktu.value,
                subject: form.jadwalPelajaran.value,
                kelas: form.jadwalKelas.value
            };
            if (!dataJadwal[day]) dataJadwal[day] = [];
            
            // Simpan state sebelum diubah untuk fitur undo
            jadwalHistory.push(JSON.parse(JSON.stringify(dataJadwal)));

            dataJadwal[day].push(newJadwal);
            // Urutkan jadwal berdasarkan waktu
            dataJadwal[day].sort((a, b) => a.time.localeCompare(b.time));
            
            localStorage.setItem('dataJadwal', JSON.stringify(dataJadwal));
            showNotification('✅ Jadwal berhasil disimpan!', 'success');
            form.reset();
            renderJadwalKalender();
        }

        // Fungsi untuk menghapus jadwal
        function deleteJadwal(day, index) {
            showModal('Konfirmasi Hapus', 'Yakin ingin menghapus jadwal ini?', () => {
                if (dataJadwal[day] && dataJadwal[day][index]) {
                    // Simpan state sebelum diubah untuk fitur undo
                    jadwalHistory.push(JSON.parse(JSON.stringify(dataJadwal)));
                    dataJadwal[day].splice(index, 1);
                    localStorage.setItem('dataJadwal', JSON.stringify(dataJadwal));
                    showNotification('🗑️ Jadwal berhasil dihapus!', 'info');
                    renderJadwalKalender();
                }
            });
        }

        // Fungsi untuk membatalkan entri jadwal terakhir
        function undoJadwal() {
            if (jadwalHistory.length > 0) {
                dataJadwal = jadwalHistory.pop(); // Kembalikan ke state sebelumnya
                localStorage.setItem('dataJadwal', JSON.stringify(dataJadwal));
                showNotification('↩️ Jadwal terakhir dibatalkan!', 'info');
                renderJadwalKalender();
            }
        }

        // Fungsi untuk memperbarui status tombol undo
        function updateJadwalUndoButton() {
            const undoBtn = document.getElementById('undoJadwalBtn');
            if (undoBtn) {
                undoBtn.disabled = jadwalHistory.length === 0;
            }
        }

        // Fungsi untuk menampilkan kalender
        function renderCalendar() {
            const container = document.getElementById('calendarGrid');
            if (!container) return;
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            let calendarHtml = '';

            for (let i = 0; i < firstDay.getDay(); i++) {
                calendarHtml += `<div class="p-2"></div>`;
            }

            for (let i = 1; i <= lastDay.getDate(); i++) {
                const dayDate = new Date(year, month, i);
                const dateKey = dayDate.toISOString().split('T')[0];
                const note = dataKalender[dateKey] || '';
                const isToday = i === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                calendarHtml += `<div class="p-2 border rounded-md text-center cursor-pointer relative ${isToday ? 'bg-blue-600 text-white font-bold' : 'bg-white hover:bg-gray-100'}" onclick="promptCalendarNote('${dateKey}')">
                    ${i}
                    ${note ? `<div class="absolute top-1 right-1 w-2 h-2 bg-yellow-400 rounded-full" title="${note}"></div>` : ''}
                </div>`;
            }
            container.innerHTML = calendarHtml;
        }

        // Fungsi untuk meminta catatan kalender
        function promptCalendarNote(dateKey) {
            const existingNote = dataKalender[dateKey] || '';
            const dateDisplay = new Date(dateKey).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});
            const bodyHtml = `
                <p>Catatan untuk tanggal: <strong>${dateDisplay}</strong></p>
                <textarea id="modal-note" rows="4" class="w-full p-2 border rounded-md mt-2">${existingNote}</textarea>
            `;
            showModalWithInputs(`Catatan Kalender`, bodyHtml, () => {
                const note = document.getElementById('modal-note').value;
                if (note.trim() !== '') {
                    dataKalender[dateKey] = note;
                    showNotification('✅ Catatan disimpan!', 'success');
                } else {
                    delete dataKalender[dateKey];
                    showNotification('🗑️ Catatan dihapus!', 'info');
                }
                localStorage.setItem('dataKalender', JSON.stringify(dataKalender));
                renderCalendar();
            });
        }


        // Fungsi untuk menampilkan konten Arsip & Dokumentasi
        function renderArsipDokumentasi() {
            const subContainer = document.getElementById('administrasi-content');
            if (!subContainer) return;
            let html = `
                <h3 class="text-xl font-semibold mb-4">Arsip & Dokumentasi</h3>
                <p class="text-gray-600 mb-4">Kelola tautan ke dokumen Anda di Google Drive.</p>
                <div class="bg-gray-50 p-6 rounded-xl border mb-6">
                    <h4 class="text-lg font-medium mb-4">Tambah Tautan Dokumen</h4>
                    <form id="arsipForm" class="flex flex-col md:flex-row gap-4 items-end">
                        <div class="flex-1 w-full">
                            <label for="arsipNamaDokumen" class="block text-sm font-medium">Nama Dokumen</label>
                            <input type="text" id="arsipNamaDokumen" placeholder="Contoh: Modul Kelas 11" class="mt-1 block w-full p-2 border rounded-md" required>
                        </div>
                        <div class="flex-1 w-full">
                            <label for="arsipLink" class="block text-sm font-medium">Tautan Google Drive</label>
                            <input type="url" id="arsipLink" placeholder="Contoh: https://drive.google.com/..." class="mt-1 block w-full p-2 border rounded-md" required>
                        </div>
                        <button type="submit" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-medium shrink-0">➕ Simpan Tautan</button>
                    </form>
                </div>
                <div class="mt-6">
                    <h4 class="text-xl font-semibold mb-4">Daftar Tautan Tersimpan</h4>
                    <div id="arsipList" class="space-y-4"></div>
                </div>
            `;
            subContainer.innerHTML = html;
            document.getElementById('arsipForm').addEventListener('submit', saveDriveLink);
            updateArsipList();
        }
        
        // Fungsi untuk menyimpan tautan drive baru
        function saveDriveLink(event) {
            event.preventDefault();
            const nama = document.getElementById('arsipNamaDokumen').value;
            const link = document.getElementById('arsipLink').value;
            if (nama && link) {
                dataArsip.push({
                    id: Date.now(),
                    name: nama,
                    link: link
                });
                localStorage.setItem('dataArsip', JSON.stringify(dataArsip));
                showNotification('✅ Tautan berhasil disimpan!', 'success');
                event.target.reset();
                updateArsipList();
            } else {
                showNotification('⚠️ Harap isi semua kolom!', 'warning');
            }
        }

        // Fungsi untuk memperbarui daftar tautan drive
        function updateArsipList() {
            const listContainer = document.getElementById('arsipList');
            if (!listContainer) return;
            if (dataArsip.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-500 py-8">Belum ada tautan tersimpan.</p>`;
                return;
            }
            listContainer.innerHTML = dataArsip.map(doc => `
                <div class="bg-gray-100 p-4 rounded-xl border flex items-center justify-between flex-wrap gap-2">
                    <div>
                        <p class="font-semibold text-gray-800">${doc.name}</p>
                        <a href="${doc.link}" target="_blank" class="text-sm text-blue-600 hover:underline break-words">${doc.link}</a>
                    </div>
                    <div class="flex gap-2 shrink-0">
                        <a href="${doc.link}" target="_blank" class="p-2 rounded-md bg-green-500 text-white hover:bg-green-600 transition-colors">Buka</a>
                        <button onclick="deleteDriveLink(${doc.id})" class="p-2 rounded-md bg-red-500 text-white hover:bg-red-600 transition-colors">🗑️ Hapus</button>
                    </div>
                </div>
            `).join('');
        }

        // Fungsi untuk menghapus tautan drive
        function deleteDriveLink(id) {
            showModal('Konfirmasi Hapus', 'Yakin ingin menghapus tautan ini?', () => {
                dataArsip = dataArsip.filter(d => d.id !== id);
                localStorage.setItem('dataArsip', JSON.stringify(dataArsip));
                showNotification('🗑️ Tautan berhasil dihapus!', 'info');
                updateArsipList();
            });
        }
        

        // Fungsi untuk menampilkan konten Biodata & Profil
        function renderBiodataProfile() {
            const subContainer = document.getElementById('administrasi-content');
            if (!subContainer) return;
            let html = `
                <h3 class="text-xl font-semibold mb-4">Biodata & Profil</h3>
                <p class="text-gray-600 mb-4">Informasi ini akan digunakan pada laporan dan cetakan dokumen.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- School Profile -->
                    <div class="bg-gray-50 p-6 rounded-xl border">
                        <h4 class="text-lg font-medium mb-4">Profil Sekolah</h4>
                        <form id="sekolahForm" class="space-y-4">
                            <div>
                                <label for="sekolahNama" class="block text-sm font-medium">Nama Sekolah</label>
                                <input type="text" id="sekolahNama" value="${dataProfil.sekolah.nama}" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="sekolahAlamat" class="block text-sm font-medium">Alamat</label>
                                <input type="text" id="sekolahAlamat" value="${dataProfil.sekolah.alamat}" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="sekolahKepsek" class="block text-sm font-medium">Kepala Sekolah</label>
                                <input type="text" id="sekolahKepsek" value="${dataProfil.sekolah.kepsek}" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <button type="button" onclick="saveProfile('sekolah')" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-medium">💾 Simpan Profil Sekolah</button>
                        </form>
                    </div>

                    <!-- Teacher Profile -->
                    <div class="bg-gray-50 p-6 rounded-xl border">
                        <h4 class="text-lg font-medium mb-4">Profil Guru</h4>
                        <form id="guruForm" class="space-y-4">
                            <div>
                                <label for="guruNama" class="block text-sm font-medium">Nama Guru</label>
                                <input type="text" id="guruNama" value="${dataProfil.guru.nama}" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="guruNip" class="block text-sm font-medium">NIP</label>
                                <input type="text" id="guruNip" value="${dataProfil.guru.nip}" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="guruBidang" class="block text-sm font-medium">Bidang Studi</label>
                                <input type="text" id="guruBidang" value="${dataProfil.guru.bidang}" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <button type="button" onclick="saveProfile('guru')" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-medium">💾 Simpan Profil Guru</button>
                        </form>
                    </div>
                </div>
            `;
            subContainer.innerHTML = html;
        }

        // Fungsi untuk menampilkan laporan administrasi
        function renderLaporanAdministrasi() {
            const subContainer = document.getElementById('administrasi-content');
            if (!subContainer) return;

            const guruNama = dataProfil.guru.nama || '_________________';
            const guruNip = dataProfil.guru.nip || '_________________';
            const sekolahNama = dataProfil.sekolah.nama || '_________________';
            const sekolahAlamat = dataProfil.sekolah.alamat || '_________________';

            // Mengumpulkan semua data yang diperlukan
            let jadwalHtml = '<ul class="list-disc list-inside space-y-1">';
            const jadwalDays = ['senin', 'selasa', 'rabu', 'kamis', 'jumat'];
            if (Object.keys(dataJadwal).length > 0) {
                jadwalDays.forEach(day => {
                    const dayTitle = day.charAt(0).toUpperCase() + day.slice(1);
                    const scheduleItems = dataJadwal[day] || [];
                    if (scheduleItems.length > 0) {
                        jadwalHtml += `<li><strong>${dayTitle}:</strong></li>`;
                        scheduleItems.forEach(item => {
                            jadwalHtml += `<ul class="list-disc list-inside ml-4"><li>${item.time} - ${item.subject} (${item.kelas})</li></ul>`;
                        });
                    }
                });
            } else {
                 jadwalHtml = '<p>Tidak ada data jadwal.</p>';
            }
            jadwalHtml += '</ul>';

            let agendaHtml = '<ul class="list-disc list-inside space-y-1">';
            if (dataAgenda.length > 0) {
                dataAgenda.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(agenda => {
                    agendaHtml += `<li>${agenda.kegiatan} (${new Date(agenda.date).toLocaleDateString('id-ID')}, ${agenda.time})</li>`;
                });
            } else {
                agendaHtml = '<p>Tidak ada data agenda.</p>';
            }
            agendaHtml += '</ul>';

            let catatanHtml = '<div class="space-y-4">';
            const siswaListWithNotes = Object.keys(dataCatatanSiswa).filter(key => dataCatatanSiswa[key].length > 0);
            if (siswaListWithNotes.length > 0) {
                siswaListWithNotes.forEach(key => {
                    const [kelas, nis] = key.split('_');
                    const siswa = dataSiswa[kelas].find(s => s.nis === nis);
                    if (siswa) {
                        catatanHtml += `<div class="border-b pb-2"><strong>${siswa.nama} (${kelas}):</strong></div><ul class="list-disc list-inside ml-4 space-y-1 mt-2">`;
                        dataCatatanSiswa[key].forEach(catatan => {
                             catatanHtml += `<li>${catatan.text} <span class="text-sm text-gray-500">(${new Date(catatan.timestamp).toLocaleDateString('id-ID')})</span></li>`;
                        });
                        catatanHtml += '</ul>';
                    }
                });
            } else {
                catatanHtml = '<p>Tidak ada data catatan siswa.</p>';
            }
            catatanHtml += '</div>';

            let arsipHtml = '<div class="overflow-x-auto"><table class="w-full border-collapse border mt-4"><thead><tr class="bg-gray-100 text-left"><th class="p-2 border">No</th><th class="p-2 border">Nama Dokumen</th><th class="p-2 border">Link</th></tr></thead><tbody>';
            if (dataArsip.length > 0) {
                 dataArsip.forEach((arsip, index) => {
                    arsipHtml += `<tr><td class="border p-2 align-top">${index + 1}</td><td class="border p-2 align-top">${arsip.name}</td><td class="border p-2 align-top"><a href="${arsip.link}" target="_blank" class="text-blue-600 hover:underline break-words">${arsip.link}</a></td></tr>`;
                });
            } else {
                arsipHtml += `<tr><td colspan="3" class="p-2 text-center">Tidak ada data arsip.</td></tr>`;
            }
            arsipHtml += '</tbody></table></div>';

            let html = `
                <div id="laporan-cetak-container" class="bg-white p-6 rounded-2xl shadow-xl">
                    <div id="laporan-content" class="p-8 mx-auto max-w-4xl">
                        <div class="text-center mb-10">
                            <h1 class="text-xl md:text-2xl font-bold text-gray-800">${sekolahNama}</h1>
                            <p class="text-sm text-gray-500">${sekolahAlamat}</p>
                            <h2 class="text-lg md:text-xl font-bold mt-6">REPORT ADMINISTRASI GURU</h2>
                            <p class="text-gray-600 text-sm">Dicetak pada: ${new Date().toLocaleDateString('id-ID', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</p>
                        </div>

                        <div class="mb-10">
                            <h3 class="text-lg font-semibold border-b-2 pb-2 mb-4">1. Jadwal Mengajar</h3>
                            <div class="text-sm">${jadwalHtml}</div>
                        </div>
                        
                        <div class="mb-10">
                            <h3 class="text-lg font-semibold border-b-2 pb-2 mb-4">2. Agenda Guru</h3>
                            <div class="text-sm">${agendaHtml}</div>
                        </div>

                        <div class="mb-10">
                            <h3 class="text-lg font-semibold border-b-2 pb-2 mb-4">3. Catatan Siswa</h3>
                            <div class="text-sm">${catatanHtml}</div>
                        </div>
                        
                        <div class="mb-10">
                            <h3 class="text-lg font-semibold border-b-2 pb-2 mb-4">4. Arsip & Dokumentasi</h3>
                            <div class="text-sm">${arsipHtml}</div>
                        </div>

                        <div class="mt-16 text-right">
                            <p>${new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}</p>
                            <p class="font-semibold text-gray-800 mt-16">${guruNama}</p>
                            <p class="text-sm text-gray-500">NIP. ${guruNip}</p>
                        </div>
                    </div>
                    <div class="no-print mt-6 flex justify-center gap-4">
                        <button onclick="cetakLaporanAdministrasiPDF()" class="bg-purple-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-purple-600 transition-colors flex items-center">🖨️ Cetak PDF</button>
                        <button onclick="cetakLaporanAdministrasiExcel()" class="bg-teal-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-teal-600 transition-colors flex items-center">📥 Ekspor Excel</button>
                    </div>
                </div>
            `;
            if (subContainer) subContainer.innerHTML = html;
        }

        // Fungsi untuk mencetak laporan administrasi ke PDF
        function cetakLaporanAdministrasiPDF() {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById('laporan-content');

            if (!element) {
                showNotification('❌ Konten laporan tidak ditemukan.', 'error');
                return;
            }

            html2canvas(element, { 
                scale: 2,
                logging: false, 
                useCORS: true 
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const doc = new jsPDF('p', 'mm', 'a4');
                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = doc.internal.pageSize.getHeight();
                const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                doc.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                heightLeft -= pdfHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pdfHeight;
                }

                doc.save('Report_Administrasi_Guru.pdf');
                showNotification('✅ Laporan berhasil dicetak ke PDF!', 'success');
            }).catch(error => {
                showNotification('❌ Gagal mencetak laporan.', 'error');
                console.error('Error saat mencetak laporan:', error);
            });
        }

        // Fungsi untuk mencetak laporan administrasi ke Excel
        function cetakLaporanAdministrasiExcel() {
            const wb = XLSX.utils.book_new();

            // Sheet: Jadwal Mengajar
            const jadwalHeader = ["Hari", "Waktu", "Mata Pelajaran", "Kelas"];
            const jadwalData = [];
            const jadwalDays = ['senin', 'selasa', 'rabu', 'kamis', 'jumat'];
            jadwalDays.forEach(day => {
                const scheduleItems = dataJadwal[day] || [];
                scheduleItems.forEach(item => {
                    jadwalData.push([day, item.time, item.subject, item.kelas]);
                });
            });
            const ws_jadwal = XLSX.utils.aoa_to_sheet([jadwalHeader, ...jadwalData]);
            XLSX.utils.book_append_sheet(wb, ws_jadwal, "Jadwal Mengajar");

            // Sheet: Agenda Guru
            const agendaHeader = ["Tanggal", "Waktu", "Kegiatan"];
            const agendaData = dataAgenda.map(a => [a.date, a.time, a.kegiatan]);
            const ws_agenda = XLSX.utils.aoa_to_sheet([agendaHeader, ...agendaData]);
            XLSX.utils.book_append_sheet(wb, ws_agenda, "Agenda Guru");

            // Sheet: Catatan Siswa
            const catatanHeader = ["Kelas", "Nama Siswa", "Catatan", "Tanggal"];
            const catatanData = [];
            for (const key in dataCatatanSiswa) {
                if (dataCatatanSiswa.hasOwnProperty(key)) {
                    const [kelas, nis] = key.split('_');
                    const siswa = dataSiswa[kelas].find(s => s.nis === nis);
                    if (siswa) {
                        dataCatatanSiswa[key].forEach(catatan => {
                            catatanData.push([kelas, siswa.nama, catatan.text, new Date(catatan.timestamp).toLocaleDateString('id-ID')]);
                        });
                    }
                }
            }
            const ws_catatan = XLSX.utils.aoa_to_sheet([catatanHeader, ...catatanData]);
            XLSX.utils.book_append_sheet(wb, ws_catatan, "Catatan Siswa");

            // Sheet: Arsip & Dokumentasi
            const arsipHeader = ["No", "Nama Dokumen", "Link"];
            const arsipData = dataArsip.map((a, index) => [index + 1, a.name, a.link]);
            const ws_arsip = XLSX.utils.aoa_to_sheet([arsipHeader, ...arsipData]);
            XLSX.utils.book_append_sheet(wb, ws_arsip, "Arsip & Dokumentasi");

            XLSX.writeFile(wb, "Report_Administrasi_Guru.xlsx");
            showNotification('✅ Laporan berhasil dicetak ke Excel!', 'success');
        }


        // Fungsi untuk menyimpan data profil
        function saveProfile(type) {
            const sekolahNamaEl = document.getElementById('sekolahNama');
            const sekolahAlamatEl = document.getElementById('sekolahAlamat');
            const sekolahKepsekEl = document.getElementById('sekolahKepsek');
            const guruNamaEl = document.getElementById('guruNama');
            const guruNipEl = document.getElementById('guruNip');
            const guruBidangEl = document.getElementById('guruBidang');

            if (type === 'sekolah' && sekolahNamaEl && sekolahAlamatEl && sekolahKepsekEl) {
                dataProfil.sekolah.nama = sekolahNamaEl.value;
                dataProfil.sekolah.alamat = sekolahAlamatEl.value;
                dataProfil.sekolah.kepsek = sekolahKepsekEl.value;
            } else if (type === 'guru' && guruNamaEl && guruNipEl && guruBidangEl) {
                dataProfil.guru.nama = guruNamaEl.value;
                dataProfil.guru.nip = guruNipEl.value;
                dataProfil.guru.bidang = guruBidangEl.value;
            }
            localStorage.setItem('dataProfil', JSON.stringify(dataProfil));
            showNotification('✅ Profil berhasil diperbarui!', 'success');
        }
        
        // Fungsi untuk menampilkan dialog konfirmasi reset data
        function resetAllDataConfirmation() {
            const bodyHtml = `
                <p class="text-red-500 font-semibold text-center mb-4">Anda yakin ingin menghapus semua data? Tindakan ini tidak dapat dibatalkan.</p>
                <p class="text-sm text-gray-500">Semua data siswa, absensi, nilai, RPP, jadwal, dan arsip akan hilang permanen.</p>
                <div class="flex items-center gap-2 mt-4">
                    <input type="checkbox" id="confirmResetCheckbox" class="rounded text-red-500">
                    <label for="confirmResetCheckbox" class="text-sm text-red-600 font-medium">Saya mengerti dan ingin melanjutkan.</label>
                </div>
            `;
            showModalWithInputs('Hapus Semua Data', bodyHtml, () => {
                const checkbox = document.getElementById('confirmResetCheckbox');
                if (checkbox.checked) {
                    resetAllData();
                } else {
                    showNotification('⚠️ Operasi dibatalkan. Anda harus mencentang kotak konfirmasi.', 'warning');
                }
            });
        }
        
        // Fungsi untuk melakukan reset data
        function resetAllData() {
            localStorage.clear();
            showNotification('🗑️ Semua data berhasil direset!', 'info');
            setTimeout(() => window.location.reload(), 1500);
        }

        // --- Manajemen Data & Logika Inti ---
        
        document.addEventListener('DOMContentLoaded', function() {
            // Perbaikan: Pastikan semua data diinisialisasi di awal jika localStorage kosong
            if (!localStorage.getItem('dataSiswa')) localStorage.setItem('dataSiswa', JSON.stringify(initialDataSiswa));
            
            setInitialDates();
            updateSelectOptions();
            showTab('dashboard'); 
            document.getElementById('kelasSelect').addEventListener('change', (e) => tampilkanDaftarSiswa(e.target.value));
            document.getElementById('tanggalAbsen').addEventListener('change', () => tampilkanDaftarSiswa(document.getElementById('kelasSelect').value));
            document.getElementById('penilaianKelas').addEventListener('change', (e) => tampilkanDaftarNilai(e.target.value));
            document.getElementById('tanggalNilai').addEventListener('change', () => tampilkanDaftarNilai(document.getElementById('penilaianKelas').value));

            // Tambahkan event listener untuk menonaktifkan klik kanan
            document.addEventListener('contextmenu', event => {
                event.preventDefault();
                showNotification('😊 Hei, konten ini dilindungi. Klik kanan dinonaktifkan untuk mencegah penyalinan source code tanpa izin. Terima kasih sudah memahami!', 'info');
            });
        });
        
        // Fungsi untuk menambah siswa baru
        function addStudent(event) {
            event.preventDefault();
            const kelas = document.getElementById('newKelas').value;
            const nama = document.getElementById('newNama').value;
            const jk = document.getElementById('newJk').value;
            if (kelas && nama && jk) {
                const nis = `generated-${Date.now()}`;
                if (!dataSiswa[kelas]) dataSiswa[kelas] = [];
                dataSiswa[kelas].push({ nis, nama, jk });
                saveDataSiswa();
                showNotification('✅ Siswa berhasil ditambahkan!', 'success');
                event.target.reset();
                updateManajemenTable(kelas);
            } else {
                showNotification('⚠️ Semua kolom harus diisi!', 'warning');
            }
        }
        
        // Fungsi untuk menyimpan data siswa ke localStorage
        function saveDataSiswa() {
            localStorage.setItem('dataSiswa', JSON.stringify(dataSiswa));
            updateSelectOptions();
        }

        // Fungsi untuk mengatur tanggal awal
        function setInitialDates() {
            const today = new Date();
            const todayISO = today.toISOString().split('T')[0];
            const currentDateEl = document.getElementById('currentDate');
            if (currentDateEl) currentDateEl.textContent = today.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            ['tanggalAbsen', 'tanggalNilai', 'agendaDate'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = todayISO;
            });
            
            // Set waktu saat ini untuk agenda
            const now = new Date();
            const timeString = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const agendaTimeEl = document.getElementById('agendaTime');
            if (agendaTimeEl) {
                agendaTimeEl.value = timeString;
            }


            // Set tanggal untuk rekap jika elemen ada
            const rekapEndDateEl = document.getElementById('rekapEndDate');
            const rekapStartDateEl = document.getElementById('rekapStartDate');
            if (rekapEndDateEl && rekapStartDateEl) {
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                rekapEndDateEl.value = todayISO;
                rekapStartDateEl.value = startOfMonth;
            }
        }

        // Fungsi untuk memperbarui semua pilihan kelas
        function updateSelectOptions() {
            const classList = Object.keys(dataSiswa).sort();
            const selectsToUpdate = ['kelasSelect', 'penilaianKelas', 'rekapKelas', 'manajemenKelas', 'newKelas', 'dashboardKelas', 'catatanKelas'];
            selectsToUpdate.forEach(selectId => {
                const selectElement = document.getElementById(selectId);
                if (!selectElement) return;
                
                const currentValue = selectElement.value;
                let optionsHtml = `<option value="">Pilih Kelas</option>`;
                const optgroups = { 'Kelas 12': [], 'Kelas 11': [], 'Kelas 10': [], 'Lainnya': [] };
                
                classList.forEach(kelas => {
                    const studentCount = dataSiswa[kelas] ? dataSiswa[kelas].length : 0;
                    const option = `<option value="${kelas}">${kelas} (${studentCount} siswa)</option>`;
                    if (kelas.startsWith('12')) optgroups['Kelas 12'].push(option);
                    else if (kelas.startsWith('11')) optgroups['Kelas 11'].push(option);
                    else if (kelas.startsWith('10')) optgroups['Kelas 10'].push(option);
                    else optgroups['Lainnya'].push(option);
                });

                for (const group in optgroups) {
                    if (optgroups[group].length > 0) {
                        optionsHtml += `<optgroup label="${group}">${optgroups[group].join('')}</optgroup>`;
                    }
                }
                
                selectElement.innerHTML = optionsHtml;
                // Coba setel kembali nilai yang dipilih sebelumnya
                if (Array.from(selectElement.options).some(opt => opt.value === currentValue)) {
                    selectElement.value = currentValue;
                }
            });
        }

        // Fungsi untuk menampilkan daftar siswa untuk absensi
        function tampilkanDaftarSiswa(kelas) {
            const container = document.getElementById('daftarSiswa');
            const actionButtons = document.getElementById('actionButtons');
            if (!container || !actionButtons) return;

            if (!kelas || !dataSiswa[kelas]) {
                container.innerHTML = `<div class="text-center text-gray-500 py-8"><div class="text-4xl mb-3">👥</div><p>Pilih kelas untuk menampilkan daftar siswa</p></div>`;
                actionButtons.style.display = 'none';
                return;
            }
            const siswaList = dataSiswa[kelas];
            const tanggal = document.getElementById('tanggalAbsen').value;
            let html = '';
            siswaList.forEach((siswa, index) => {
                const key = `${kelas}_${siswa.nis}_${tanggal}`;
                const currentStatus = dataAbsensi[key];
                html += `<div class="bg-white border rounded-xl p-3 lg:p-4 hover:shadow-md transition-all fade-in mobile-card"><div class="flex flex-col lg:flex-row lg:items-center justify-between gap-3"><div class="flex items-center gap-4"><div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold shrink-0">${index + 1}</div><div><h3 class="font-semibold text-gray-800">${siswa.nama}</h3><p class="text-sm text-gray-600">${siswa.jk === 'L' ? 'Laki-laki' : 'Perempuan'}</p></div></div><div class="mobile-grid lg:flex lg:gap-2" id="status-group-${siswa.nis}"><button onclick="setStatus(this, '${key}', 'hadir')" class="status-btn status-btn-mobile p-2 rounded-lg text-sm font-medium ${currentStatus === 'hadir' ? 'bg-green-500 text-white shadow-lg' : 'bg-gray-100 text-gray-600 hover:bg-green-100'}">✅<span class="hidden lg:inline"> Hadir</span></button><button onclick="setStatus(this, '${key}', 'sakit')" class="status-btn status-btn-mobile p-2 rounded-lg text-sm font-medium ${currentStatus === 'sakit' ? 'bg-yellow-500 text-white shadow-lg' : 'bg-gray-100 text-gray-600 hover:bg-yellow-100'}">🤒<span class="hidden lg:inline"> Sakit</span></button><button onclick="setStatus(this, '${key}', 'izin')" class="status-btn status-btn-mobile p-2 rounded-lg text-sm font-medium ${currentStatus === 'izin' ? 'bg-blue-500 text-white shadow-lg' : 'bg-gray-100 text-gray-600 hover:bg-blue-100'}">📝<span class="hidden lg:inline"> Izin</span></button><button onclick="setStatus(this, '${key}', 'alpa')" class="status-btn status-btn-mobile p-2 rounded-lg text-sm font-medium ${currentStatus === 'alpa' ? 'bg-red-500 text-white shadow-lg' : 'bg-gray-100 text-gray-600 hover:bg-red-100'}">❌<span class="hidden lg:inline"> Alpa</span></button></div></div></div>`;
            });
            container.innerHTML = html;
            actionButtons.style.display = 'flex';
        }

        function setStatus(buttonElement, key, status) {
            dataAbsensi[key] = status;
            const buttonGroup = buttonElement.parentElement;
            buttonGroup.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-blue-500', 'bg-red-500', 'text-white', 'shadow-lg');
                btn.classList.add('bg-gray-100', 'text-gray-600');
            });
            buttonElement.classList.remove('bg-gray-100', 'text-gray-600');
            const statusClasses = {hadir: 'bg-green-500', sakit: 'bg-yellow-500', izin: 'bg-blue-500', alpa: 'bg-red-500'};
            buttonElement.classList.add('text-white', 'shadow-lg', statusClasses[status]);
        }

        // Fungsi baru untuk menandai semua siswa sebagai "Hadir"
        function hadirSemua() {
            const kelas = document.getElementById('kelasSelect').value;
            const tanggal = document.getElementById('tanggalAbsen').value;
            if (!kelas || !dataSiswa[kelas] || !tanggal) {
                 showNotification('⚠️ Pilih kelas dan tanggal terlebih dahulu!', 'warning');
                 return;
            }

            dataSiswa[kelas].forEach(siswa => {
                const key = `${kelas}_${siswa.nis}_${tanggal}`;
                dataAbsensi[key] = 'hadir';
            });
            
            // Perbarui tampilan di halaman secara manual
            const siswaList = document.querySelectorAll('#daftarSiswa .mobile-card');
            siswaList.forEach(card => {
                const hadirButton = card.querySelector('.status-btn:first-child');
                const otherButtons = card.querySelectorAll('.status-btn:not(:first-child)');
                
                hadirButton.classList.remove('bg-gray-100', 'text-gray-600');
                hadirButton.classList.add('bg-green-500', 'text-white', 'shadow-lg');
                
                otherButtons.forEach(btn => {
                    btn.classList.remove('bg-yellow-500', 'bg-blue-500', 'bg-red-500', 'text-white', 'shadow-lg');
                    btn.classList.add('bg-gray-100', 'text-gray-600');
                });
            });
            
            showNotification('✅ Semua siswa berhasil disetel "Hadir"!', 'success');
        }
        
        function simpanAbsensi() {
            localStorage.setItem('dataAbsensi', JSON.stringify(dataAbsensi));
            showNotification('✅ Absensi berhasil disimpan!', 'success');
        }

        function resetAbsensi() {
            const kelas = document.getElementById('kelasSelect').value;
            const tanggal = document.getElementById('tanggalAbsen').value;
            if (kelas && tanggal) {
                dataSiswa[kelas].forEach(siswa => {
                    delete dataAbsensi[`${kelas}_${siswa.nis}_${tanggal}`];
                });
                tampilkanDaftarSiswa(kelas);
                showNotification('🔄 Absensi hari ini telah direset', 'info');
            }
        }
        
        function tampilkanDaftarNilai(kelas) {
            const container = document.getElementById('daftarNilai');
            const actionButtons = document.getElementById('actionNilaiButtons');
            const materiInput = document.getElementById('materiNilai');
            if (!container || !actionButtons) return;

            if (!kelas || !dataSiswa[kelas]) {
                container.innerHTML = `<div class="text-center text-gray-500 py-8"><div class="text-4xl mb-3">📝</div><p>Pilih kelas untuk memasukkan nilai</p></div>`;
                actionButtons.style.display = 'none'; return;
            }
            const tanggal = document.getElementById('tanggalNilai').value;
            if (!tanggal) {
                container.innerHTML = `<div class="text-center text-gray-500 py-8"><div class="text-4xl mb-3">📅</div><p>Pilih tanggal untuk memasukkan nilai</p></div>`;
                actionButtons.style.display = 'none'; return;
            }
            materiInput.value = dataMateri[`${kelas}_${tanggal}`] || '';
            let html = `<table class="w-full border-collapse bg-white rounded-lg overflow-hidden shadow-sm"><thead class="bg-gray-50"><tr><th class="p-3 text-left text-sm font-medium">No</th><th class="p-3 text-left text-sm font-medium">Nama Siswa</th><th class="p-3 text-center text-sm font-medium">Nilai Harian</th><th class="p-3 text-center text-sm font-medium">Nilai Tugas</th></tr></thead><tbody>`;
            dataSiswa[kelas].forEach((siswa, index) => {
                const keyHarian = `${kelas}_${siswa.nis}_harian_${tanggal}`;
                const keyTugas = `${kelas}_${siswa.nis}_tugas_${tanggal}`;
                html += `<tr class="hover:bg-gray-50"><td class="p-3 border-b">${index + 1}</td><td class="p-3 border-b font-medium">${siswa.nama}</td><td class="p-3 border-b text-center"><input type="number" oninput="updateNilai('${keyHarian}', this.value)" value="${dataNilai[keyHarian] || ''}" min="0" max="100" class="w-20 text-center border rounded-md"></td><td class="p-3 border-b text-center"><input type="number" oninput="updateNilai('${keyTugas}', this.value)" value="${dataNilai[keyTugas] || ''}" min="0" max="100" class="w-20 text-center border rounded-md"></td></tr>`;
            });
            container.innerHTML = html + `</tbody></table>`;
            actionButtons.style.display = 'flex';
        }
        
        function updateNilai(key, value) {
            const nilai = parseInt(value, 10);
            if (!isNaN(nilai) && nilai >= 0 && nilai <= 100) {
                dataNilai[key] = nilai;
            } else if (value === '') {
                delete dataNilai[key];
            }
        }

        function simpanNilai() {
            const kelas = document.getElementById('penilaianKelas').value;
            const tanggal = document.getElementById('tanggalNilai').value;
            const materi = document.getElementById('materiNilai').value;
            if (kelas && tanggal) {
                const materiKey = `${kelas}_${tanggal}`;
                if (materi) dataMateri[materiKey] = materi;
                else delete dataMateri[materiKey];
                localStorage.setItem('dataMateri', JSON.stringify(dataMateri));
            }
            localStorage.setItem('dataNilai', JSON.stringify(dataNilai));
            showNotification('✅ Nilai & Materi berhasil disimpan!', 'success');
        }

        function showNotification(message, type) {
            const colors = { success: 'bg-green-500', info: 'bg-blue-500', warning: 'bg-yellow-500', error: 'bg-red-500' };
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-[101] fade-in`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function getWorkingDays(startDate, endDate) {
            let count = 0;
            const current = new Date(startDate);
            const end = new Date(endDate);
            while (current <= end) {
                const day = current.getDay();
                if (day >= 1 && day <= 5) { // Senin sampai Jumat
                    count++; 
                }
                current.setDate(current.getDate() + 1);
            }
            return count;
        }

        function generateReportData(kelas, startDateStr, endDateStr, searchQuery = '') {
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            let siswaList = (dataSiswa[kelas] || []).filter(s => s.nama.toLowerCase().includes(searchQuery.toLowerCase()));
            const reportData = { absensi: { totals: { hadir: 0, sakit: 0, izin: 0, alpa: 0 }, students: [] }, nilai: { students: [] } };
            const totalWorkingDays = getWorkingDays(startDate, endDate);
            
            siswaList.forEach((siswa, index) => {
                let hadir = 0, sakit = 0, izin = 0, alpa = 0;
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const day = d.getDay();
                    if (day >= 1 && day <= 5) { // Hanya hitung Senin-Jumat
                        const status = dataAbsensi[`${kelas}_${siswa.nis}_${d.toISOString().split('T')[0]}`];
                        if (status === 'hadir') hadir++; 
                        else if (status === 'sakit') sakit++; 
                        else if (status === 'izin') izin++; 
                        else if (status === 'alpa') alpa++;
                    }
                }
                reportData.absensi.students.push({ no: index + 1, nama: siswa.nama, hadir, sakit, izin, alpa, persentase: totalWorkingDays > 0 ? ((hadir / totalWorkingDays) * 100).toFixed(1) : 0 });
                Object.keys(reportData.absensi.totals).forEach(key => reportData.absensi.totals[key] += {hadir, sakit, izin, alpa}[key]);
                
                let totalHarian = 0, countHarian = 0, totalTugas = 0, countTugas = 0;
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    const nilaiHarian = dataNilai[`${kelas}_${siswa.nis}_harian_${dateStr}`];
                    const nilaiTugas = dataNilai[`${kelas}_${siswa.nis}_tugas_${dateStr}`];
                    if (nilaiHarian !== undefined) { totalHarian += nilaiHarian; countHarian++; }
                    if (nilaiTugas !== undefined) { totalTugas += nilaiTugas; countTugas++; }
                }
                const rataRataHarian = countHarian > 0 ? (totalHarian / countHarian).toFixed(2) : '0.00';
                const rataRataTugas = countTugas > 0 ? (totalTugas / countTugas).toFixed(2) : '0.00';
                const nilaiAkhir = (countHarian + countTugas) > 0 ? ((totalHarian + totalTugas) / (countHarian + countTugas)).toFixed(2) : '0.00';
                reportData.nilai.students.push({ no: index + 1, nama: siswa.nama, rataRataHarian, rataRataTugas, nilaiAkhir });
            });
            return reportData;
        }

        // Fungsi utama untuk menangani rekap dan laporan
        function updateRekap() {
            const kelas = document.getElementById('rekapKelas').value;
            const startDateStr = document.getElementById('rekapStartDate').value;
            const endDateStr = document.getElementById('rekapEndDate').value;
            const searchQuery = document.getElementById('rekapSearch').value;

            const recapTableBody = document.getElementById('rekapTable');
            const laporanPreviewContainer = document.getElementById('laporanPreview');

            if (!recapTableBody || !laporanPreviewContainer) return;

            if (!kelas || !startDateStr || !endDateStr) {
                recapTableBody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-500">Pilih kelas dan rentang tanggal</td></tr>`;
                laporanPreviewContainer.innerHTML = `<div class="text-center text-gray-500 py-8"><div class="text-4xl mb-3">📄</div><p>Pilih kelas dan rentang tanggal untuk preview laporan</p></div>`;
                return;
            }

            const reportData = generateReportData(kelas, startDateStr, endDateStr, searchQuery);
            const { totals, students } = reportData.absensi;

            // Update Statistik Rekap
            const totalHadirEl = document.getElementById('totalHadir');
            if (totalHadirEl) totalHadirEl.textContent = totals.hadir;
            const totalSakitEl = document.getElementById('totalSakit');
            if (totalSakitEl) totalSakitEl.textContent = totals.sakit;
            const totalIzinEl = document.getElementById('totalIzin');
            if (totalIzinEl) totalIzinEl.textContent = totals.izin;
            const totalAlpaEl = document.getElementById('totalAlpa');
            if (totalAlpaEl) totalAlpaEl.textContent = totals.alpa;

            // Update Tabel Rekap
            let recapTableHtml = '';
            if (students.length === 0) recapTableHtml = `<tr><td colspan="7" class="p-8 text-center text-gray-500">Tidak ada data.</td></tr>`;
            else students.forEach(s => {
                recapTableHtml += `<tr class="hover:bg-gray-50"><td class="p-3 border-b">${s.no}</td><td class="p-3 border-b font-medium">${s.nama}</td><td class="p-3 border-b text-center"><span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">${s.hadir}</span></td><td class="p-3 border-b text-center"><span class="px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">${s.sakit}</span></td><td class="p-3 border-b text-center"><span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${s.izin}</span></td><td class="p-3 border-b text-center"><span class="px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">${s.alpa}</span></td><td class="p-3 border-b text-center font-semibold ${s.persentase >= 80 ? 'text-green-600' : s.persentase >= 60 ? 'text-yellow-600' : 'text-red-600'}">${s.persentase}%</td></tr>`;
            });
            recapTableBody.innerHTML = recapTableHtml;

            // Update Preview Laporan
            const namaGuru = dataProfil.guru.nama || '_________________';
            const mataPelajaran = dataProfil.guru.bidang || 'Guru Mata Pelajaran';
            const namaSekolah = dataProfil.sekolah.nama || '_________________';
            const alamatSekolah = dataProfil.sekolah.alamat || '_________________';
            const namaKepsek = dataProfil.sekolah.kepsek || '_________________';

            const period = `${new Date(startDateStr).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})} - ${new Date(endDateStr).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}`;
            let absensiBody = reportData.absensi.students.map(s => `<tr><td class="border p-2">${s.no}</td><td class="border p-2">${s.nama}</td><td class="p-2 border-b text-center">${s.hadir}</td><td class="p-2 border-b text-center">${s.sakit}</td><td class="p-2 border-b text-center">${s.izin}</td><td class="p-2 border-b text-center">${s.alpa}</td><td class="p-2 border-b text-center">${s.persentase}%</td></tr>`).join('');
            
            let nilaiBody = reportData.nilai.students.map(s => `<tr><td class="p-2 border-b">${s.no}</td><td class="p-2 border-b">${s.nama}</td><td class="p-2 border-b text-center">${s.rataRataHarian}</td><td class="p-2 border-b text-center">${s.rataRataTugas}</td><td class="p-2 border-b text-center font-bold">${s.nilaiAkhir}</td></tr>`).join('');
            
            laporanPreviewContainer.innerHTML = `<div class="print-only text-sm"><div class="text-center mb-6"><h1 class="text-2xl font-bold">${namaSekolah}</h1><p>${alamatSekolah}</p><h2 class="text-xl font-semibold mt-4">LAPORAN ABSENSI & NILAI</h2><p class="text-lg">Kelas ${kelas}</p><p>Periode: ${period}</p></div></div><div class="no-print mb-4"><h3 class="text-lg font-semibold">Preview Laporan Lengkap</h3><p>Periode: ${period}</p></div><div id="absensi-laporan"><h3 class="text-lg font-semibold mb-2 mt-4">Laporan Absensi</h3><div class="overflow-x-auto"><table class="w-full border-collapse border"><thead><tr class="bg-gray-100"><th class="p-2 text-left">No</th><th class="p-2 text-left">Nama</th><th class="p-2 text-center">H</th><th class="p-2 text-center">S</th><th class="p-2 text-center">I</th><th class="p-2 text-center">A</th><th class="p-2 text-center">%</th></tr></thead><tbody>${absensiBody}</tbody></table></div></div><div id="nilai-laporan" class="mt-8"><h3 class="text-lg font-semibold mb-2">Laporan Nilai</h3><div class="overflow-x-auto"><table class="w-full border-collapse border"><thead><tr class="bg-gray-100"><th class="p-2 text-left">No</th><th class="p-2 text-left">Nama</th><th class="p-2 text-center">Rata Harian</th><th class="p-2 text-center">Rata Tugas</th><th class="p-2 text-center font-bold">Nilai Akhir</th></tr></thead><tbody>${nilaiBody}</tbody></table></div></div><div class="print-only mt-8 text-sm"><div class="flex justify-between"><div class="text-center"><p>Mengetahui,</p><p>Kepala Sekolah</p><br><br><br><p>${namaKepsek}</p></div><div class="text-center"><p>${new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}</p><p>${mataPelajaran}</p><br><br><br><p>${namaGuru}</p></div></div></div>`;
        }


        // Fungsi cetak laporan yang sudah diperbaiki
        function cetakLaporan() {
            if (!document.getElementById('rekapKelas').value) { showNotification('⚠️ Pilih kelas terlebih dahulu!', 'warning'); return; }
            window.print();
        }


        // Fungsi export Excel yang sudah diperbaiki
        function exportToExcel() {
            const kelas = document.getElementById('rekapKelas').value;
            const startDateStr = document.getElementById('rekapStartDate').value;
            const endDateStr = document.getElementById('rekapEndDate').value;
            if (!kelas || !startDateStr || !endDateStr) { showNotification('⚠️ Pilih kelas dan rentang tanggal!', 'warning'); return; }
            const reportData = generateReportData(kelas, startDateStr, endDateStr, document.getElementById('rekapSearch').value);
            if (reportData.absensi.students.length === 0) { showNotification(`⚠️ Tidak ada siswa untuk diekspor!`, 'warning'); return; }
            
            // Buat workbook baru
            const wb = XLSX.utils.book_new();

            // Sheet untuk data absensi
            const absensiData = [["No", "Nama Siswa", "Hadir", "Sakit", "Izin", "Alpa", "%"]].concat(reportData.absensi.students.map(s => [s.no, s.nama, s.hadir, s.sakit, s.izin, s.alpa, s.persentase]));
            const ws_absensi = XLSX.utils.aoa_to_sheet(absensiData);
            XLSX.utils.book_append_sheet(wb, ws_absensi, "Absensi");

            // Sheet untuk data nilai
            const nilaiData = [["No", "Nama Siswa", "Rata Harian", "Rata Tugas", "Nilai Akhir"]].concat(reportData.nilai.students.map(s => [s.no, s.nama, s.rataRataHarian, s.rataRataTugas, s.nilaiAkhir]));
            const ws_nilai = XLSX.utils.aoa_to_sheet(nilaiData);
            XLSX.utils.book_append_sheet(wb, ws_nilai, "Nilai");
            
            // Tulis dan unduh file
            XLSX.writeFile(wb, `Laporan_Kelas_${kelas}.xlsx`);
            showNotification('✅ Laporan berhasil dicetak ke Excel!', 'success');
        }

        function exportData() {
            const dataToExport = { dataSiswa, dataAbsensi, dataNilai, dataMateri, dataRpp, dataJadwal, dataArsip, dataProfil, dataKalender, dataAgenda, dataCatatanSiswa };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `sim_guru_backup_${new Date().toISOString().split('T')[0]}.json`; a.click();
            URL.revokeObjectURL(url);
            showNotification('📥 Data berhasil diekspor!', 'success');
        }

        function importData() {
            const file = document.getElementById('importFile').files[0];
            if (!file) { showNotification('⚠️ Pilih file JSON!', 'warning'); return; }
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (importedData.dataSiswa === undefined || importedData.dataAbsensi === undefined || importedData.dataNilai === undefined) throw new Error("File tidak valid");
                    showModal('Konfirmasi Impor', `Ini akan MENIMPA semua data saat ini. Lanjutkan?`, () => {
                        dataSiswa = importedData.dataSiswa || initialDataSiswa;
                        dataAbsensi = importedData.dataAbsensi || {};
                        dataNilai = importedData.dataNilai || {};
                        dataMateri = importedData.dataMateri || {};
                        dataRpp = importedData.dataRpp || [];
                        dataJadwal = importedData.dataJadwal || {};
                        dataArsip = importedData.dataArsip || [];
                        dataKalender = importedData.dataKalender || {};
                        dataProfil = importedData.dataProfil || {};
                        dataAgenda = importedData.dataAgenda || [];
                        dataCatatanSiswa = importedData.dataCatatanSiswa || {};
                        
                        localStorage.setItem('dataSiswa', JSON.stringify(dataSiswa));
                        localStorage.setItem('dataAbsensi', JSON.stringify(dataAbsensi));
                        localStorage.setItem('dataNilai', JSON.stringify(dataNilai));
                        localStorage.setItem('dataMateri', JSON.stringify(dataMateri));
                        localStorage.setItem('dataRpp', JSON.stringify(dataRpp));
                        localStorage.setItem('dataJadwal', JSON.stringify(dataJadwal));
                        localStorage.setItem('dataArsip', JSON.stringify(dataArsip));
                        localStorage.setItem('dataKalender', JSON.stringify(dataKalender));
                        localStorage.setItem('dataProfil', JSON.stringify(dataProfil));
                        localStorage.setItem('dataAgenda', JSON.stringify(dataAgenda));
                        localStorage.setItem('dataCatatanSiswa', JSON.stringify(dataCatatanSiswa));

                        showNotification('✅ Data berhasil diimpor!', 'success');
                        setTimeout(() => window.location.reload(), 1500);
                    });
                } catch (e) { showNotification('❌ Gagal memproses file. Pastikan file JSON valid.', 'error'); }
            };
            reader.readAsText(file);
        }

        function updateDashboard() {
            const kelas = document.getElementById('dashboardKelas')?.value;
            const siswaNis = document.getElementById('dashboardSiswa')?.value;
            const dashboardContent = document.getElementById('dashboardStatsContent');

            if (!dashboardContent) return;
            
            localStorage.setItem('lastDashboardKelas', kelas);
            
            const dashboardKelasSelect = document.getElementById('dashboardKelas');
            const dashboardSiswaSelect = document.getElementById('dashboardSiswa');
            
            if (currentDashboardSubMenu === 'siswa') {
                if (dashboardSiswaSelect) {
                    dashboardSiswaSelect.innerHTML = `<option value="">Pilih Siswa</option>`;
                    if (kelas && dataSiswa[kelas]) {
                        dataSiswa[kelas].sort((a, b) => a.nama.localeCompare(b.nama)).forEach(siswa => {
                            dashboardSiswaSelect.innerHTML += `<option value="${siswa.nis}">${siswa.nama}</option>`;
                        });
                        dashboardSiswaSelect.disabled = false;
                    } else {
                        dashboardSiswaSelect.disabled = true;
                    }
                    if (siswaNis && dashboardSiswaSelect.querySelector(`option[value="${siswaNis}"]`)) {
                        dashboardSiswaSelect.value = siswaNis;
                    } else {
                        dashboardSiswaSelect.value = "";
                    }
                }
            }


            if (!kelas) {
                 dashboardContent.innerHTML = `<div class="text-center text-gray-500 py-8">
                     <div class="text-4xl mb-3">📈</div>
                     <p>Pilih kelas untuk menampilkan statistik kelas. Pilih siswa untuk detail individu.</p>
                 </div>`;
                 return;
            }

            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
            
            if (currentDashboardSubMenu === 'siswa' && siswaNis) {
                // Statistik individu
                const selectedSiswa = dataSiswa[kelas].find(s => s.nis === siswaNis);
                const namaSiswa = selectedSiswa ? selectedSiswa.nama : 'Siswa Tidak Ditemukan';
                
                let hadir = 0, sakit = 0, izin = 0, alpa = 0;
                const totalWorkingDays = getWorkingDays(startOfMonth, endOfMonth);
                for (let d = new Date(startOfMonth); d <= new Date(endOfMonth); d.setDate(d.getDate() + 1)) {
                    const day = d.getDay();
                    if (day >= 1 && day <= 5) {
                        const status = dataAbsensi[`${kelas}_${siswaNis}_${d.toISOString().split('T')[0]}`];
                        if (status === 'hadir') hadir++;
                        else if (status === 'sakit') sakit++;
                        else if (status === 'izin') izin++;
                        else if (status === 'alpa') alpa++;
                    }
                }

                let totalNilaiHarian = 0, countNilaiHarian = 0;
                let totalNilaiTugas = 0, countNilaiTugas = 0;
                for (let d = new Date(startOfMonth); d <= new Date(endOfMonth); d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    const nilaiHarian = dataNilai[`${kelas}_${siswaNis}_harian_${dateStr}`];
                    const nilaiTugas = dataNilai[`${kelas}_${siswaNis}_tugas_${dateStr}`];
                    if (nilaiHarian !== undefined) { totalNilaiHarian += nilaiHarian; countNilaiHarian++; }
                    if (nilaiTugas !== undefined) { totalNilaiTugas += nilaiTugas; countNilaiTugas++; }
                }
                const rataRataHarian = countNilaiHarian > 0 ? (totalNilaiHarian / countNilaiHarian).toFixed(2) : '0.00';
                const rataRataTugas = countNilaiTugas > 0 ? (totalNilaiTugas / countNilaiTugas).toFixed(2) : '0.00';
                const nilaiAkhir = (countNilaiHarian + countNilaiTugas) > 0 ? ((totalNilaiHarian + totalNilaiTugas) / (countNilaiHarian + countNilaiTugas)).toFixed(2) : '0.00';
                
                dashboardContent.innerHTML = `
                    <h3 class="text-xl font-semibold mb-4">Ringkasan Statistik Siswa: ${namaSiswa} (Kelas ${kelas})</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-4 rounded-xl border">
                            <h4 class="text-lg font-medium mb-4">Statistik Kehadiran (Bulan Ini)</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-3 bg-green-100 rounded-lg text-center">
                                    <p class="text-green-700 text-3xl font-bold">${hadir}</p>
                                    <p class="text-sm text-green-600">Hadir</p>
                                </div>
                                <div class="p-3 bg-yellow-100 rounded-lg text-center">
                                    <p class="text-yellow-700 text-3xl font-bold">${sakit}</p>
                                    <p class="text-sm text-yellow-600">Sakit</p>
                                </div>
                                <div class="p-3 bg-blue-100 rounded-lg text-center">
                                    <p class="text-blue-700 text-3xl font-bold">${izin}</p>
                                    <p class="text-sm text-blue-600">Izin</p>
                                </div>
                                <div class="p-3 bg-red-100 rounded-lg text-center">
                                    <p class="text-red-700 text-3xl font-bold">${alpa}</p>
                                    <p class="text-sm text-red-600">Alpa</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-xl border">
                            <h4 class="text-lg font-medium mb-4">Rata-rata Nilai (Bulan Ini)</h4>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-3 bg-white rounded-lg border">
                                    <p class="text-sm text-gray-600">Nilai Harian</p>
                                    <p class="font-bold text-lg">${rataRataHarian}</p>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-white rounded-lg border">
                                    <p class="text-sm text-gray-600">Nilai Tugas</p>
                                    <p class="font-bold text-lg">${rataRataTugas}</p>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-white rounded-lg border">
                                    <p class="text-lg font-bold text-gray-800">Nilai Akhir</p>
                                    <p class="font-bold text-2xl text-blue-600">${nilaiAkhir}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (kelas) {
                // Statistik seluruh kelas
                const reportData = generateReportData(kelas, startOfMonth, endOfMonth);
                const { totals, students } = reportData.absensi;
                const totalKehadiran = totals.hadir + totals.sakit + totals.izin + totals.alpa;
                
                let totalNilaiKumulatif = 0;
                let totalSiswaNilai = 0;
                students.forEach(s => {
                    const nilaiAkhirNum = parseFloat(s.nilaiAkhir);
                    if (!isNaN(nilaiAkhirNum)) {
                        totalNilaiKumulatif += nilaiAkhirNum;
                        totalSiswaNilai++;
                    }
                });
                const rataRataNilaiKelas = totalSiswaNilai > 0 ? (totalNilaiKumulatif / totalSiswaNilai).toFixed(2) : '0.00';
                
                dashboardContent.innerHTML = `
                    <h3 class="text-xl font-semibold mb-4">Ringkasan Kelas ${kelas} (Bulan Ini)</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-4 rounded-xl border">
                            <h4 class="text-lg font-medium mb-2">Statistik Kehadiran</h4>
                            ${totalKehadiran > 0 ? '<canvas id="kehadiranChart"></canvas>' : '<p class="text-center text-gray-500 py-10">Belum ada data kehadiran bulan ini.</p>'}
                        </div>
                        <div class="bg-gray-50 p-4 rounded-xl border flex flex-col justify-center">
                            <h4 class="text-lg font-medium mb-2">Performa Nilai Rata-Rata</h4>
                            <div class="text-center py-8">
                                <p class="text-5xl font-bold text-blue-600">${rataRataNilaiKelas}</p>
                                <p class="text-gray-500 mt-2">Nilai Akhir Rata-Rata Kelas</p>
                            </div>
                        </div>
                    </div>
                `;

                if (totalKehadiran > 0) {
                    const ctx = document.getElementById('kehadiranChart').getContext('2d');
                    if (kehadiranChart) kehadiranChart.destroy();
                    
                    const gradientHadir = ctx.createLinearGradient(0, 0, 0, 200); gradientHadir.addColorStop(0, '#6EE7B7'); gradientHadir.addColorStop(1, '#10B981');
                    const gradientSakit = ctx.createLinearGradient(0, 0, 0, 200); gradientSakit.addColorStop(0, '#FBBF24'); gradientSakit.addColorStop(1, '#F59E0B');
                    const gradientIzin = ctx.createLinearGradient(0, 0, 0, 200); gradientIzin.addColorStop(0, '#93C5FD'); gradientIzin.addColorStop(1, '#3B82F6');
                    const gradientAlpa = ctx.createLinearGradient(0, 0, 0, 200); gradientAlpa.addColorStop(0, '#F87171'); gradientAlpa.addColorStop(1, '#EF4444');
                    
                    kehadiranChart = new Chart(ctx, { 
                        type: 'doughnut', 
                        data: { 
                            labels: ['Hadir', 'Sakit', 'Izin', 'Alpa'], 
                            datasets: [{ 
                                data: [totals.hadir, totals.sakit, totals.izin, totals.alpa], 
                                backgroundColor: [gradientHadir, gradientSakit, gradientIzin, gradientAlpa], 
                                hoverOffset: 8,
                                borderColor: '#ffffff',
                                borderWidth: 4
                            }] 
                        }, 
                        options: { 
                            responsive: true, 
                            plugins: { 
                                legend: { position: 'bottom' } 
                            },
                            cutout: '70%'
                        } 
                    });
                }
            }
        }

        function deleteSiswa(kelas, nisToDelete) {
            showModal('Konfirmasi Hapus', `Yakin ingin menghapus siswa ini? Semua data absensi dan nilai terkait akan dihapus permanen.`, () => {
                dataSiswa[kelas] = dataSiswa[kelas].filter(s => s.nis !== nisToDelete);
                // Menghapus data absensi terkait siswa
                Object.keys(dataAbsensi).forEach(key => {
                    const parts = key.split('_');
                    if (parts.length >= 2 && parts[0] === kelas && parts[1] === nisToDelete) {
                        delete dataAbsensi[key];
                    }
                });
                // Menghapus data nilai terkait siswa
                Object.keys(dataNilai).forEach(key => {
                    const parts = key.split('_');
                    if (parts.length >= 2 && parts[0] === kelas && parts[1] === nisToDelete) {
                        delete dataNilai[key];
                    }
                });
                localStorage.setItem('dataAbsensi', JSON.stringify(dataAbsensi));
                localStorage.setItem('dataNilai', JSON.stringify(dataNilai));
                saveDataSiswa();
                showNotification('🗑️ Siswa berhasil dihapus!', 'info');
                updateManajemenTable(kelas);
            });
        }

        function editSiswa(oldKelas, oldNis, newNama, newJk, newKelas) {
            if (newKelas && newKelas !== oldKelas) {
                const siswaToMove = dataSiswa[oldKelas].find(s => s.nis === oldNis);
                if (siswaToMove) {
                    siswaToMove.nama = newNama; siswaToMove.jk = newJk;
                    dataSiswa[oldKelas] = dataSiswa[oldKelas].filter(s => s.nis !== oldNis);
                    if (!dataSiswa[newKelas]) dataSiswa[newKelas] = [];
                    dataSiswa[newKelas].push(siswaToMove);
                    
                    // Pindahkan data absensi dan nilai
                    Object.keys(dataAbsensi).forEach(key => { 
                        const p = key.split('_');
                        if (p[0] === oldKelas && p[1] === oldNis) {
                            dataAbsensi[`${newKelas}_${p[1]}_${p[2]}`] = dataAbsensi[key];
                            delete dataAbsensi[key];
                        }
                    });
                    Object.keys(dataNilai).forEach(key => { 
                        const p = key.split('_');
                        if (p[0] === oldKelas && p[1] === oldNis) {
                             // Perbaikan: Pastikan format key baru benar
                             dataNilai[`${newKelas}_${p[1]}_${p[2]}_${p[3]}`] = dataNilai[key];
                             delete dataNilai[key];
                        }
                    });
                    localStorage.setItem('dataAbsensi', JSON.stringify(dataAbsensi));
                    localStorage.setItem('dataNilai', JSON.stringify(dataNilai));
                    showNotification('🔄 Siswa berhasil dipindah kelas!', 'success');
                }
            } else {
                const siswaIndex = dataSiswa[oldKelas].findIndex(s => s.nis === oldNis);
                if (siswaIndex !== -1) { dataSiswa[oldKelas][siswaIndex].nama = newNama; dataSiswa[oldKelas][siswaIndex].jk = newJk; showNotification('✅ Data siswa diperbarui!', 'success'); }
            }
            saveDataSiswa();
            updateManajemenTable(newKelas || oldKelas);
        }

        function updateManajemenTable(kelas) {
            const container = document.getElementById('manajemenTableContainer');
            if (!container) return;
            if (!kelas || !dataSiswa[kelas]) { container.innerHTML = `<div class="text-center text-gray-500 py-8"><div class="text-4xl mb-3">🧑‍🎓</div><p>Pilih kelas untuk menampilkan data siswa</p></div>`; return; }
            
            let bodyHtml = '';
            dataSiswa[kelas].forEach((siswa, index) => {
                bodyHtml += `<tr class="hover:bg-gray-50"><td class="p-3 border-b">${index + 1}</td><td class="p-3 border-b font-medium">${siswa.nama}</td><td class="p-3 border-b">${siswa.jk}</td><td class="p-3 border-b text-center"><button onclick="promptEdit('${kelas}', '${siswa.nis}', '${siswa.nama.replace(/'/g, "\\'")}', '${siswa.jk}')" class="text-blue-600 mr-2">✏️ Edit</button><button onclick="deleteSiswa('${kelas}', '${siswa.nis}')" class="text-red-600">🗑️ Hapus</button></td></tr>`;
            });
            container.innerHTML = `<table class="w-full border-collapse bg-white rounded-lg overflow-hidden shadow-sm"><thead class="bg-gray-50"><tr><th class="p-3 text-left text-sm font-medium">No</th><th class="p-3 text-left text-sm font-medium">Nama Siswa</th><th class="p-3 text-left text-sm font-medium">J/K</th><th class="p-3 text-center text-sm font-medium">Aksi</th></tr></thead><tbody>${bodyHtml}</tbody></table>`;
        }

        // Perbaikan: Ganti id `modal-kelas` di sini menjadi `modal-kelas-pindah` untuk menghindari duplikasi id
        function promptEdit(kelas, oldNis, oldNama, oldJk) {
            const bodyHtml = `<label class="block text-sm font-medium">Nama Siswa</label><input type="text" id="modal-nama" class="mt-1 block w-full p-2 border rounded-md" value="${oldNama}"><label class="block text-sm font-medium mt-4">Jenis Kelamin</label><select id="modal-jk" class="mt-1 block w-full p-2 border rounded-md"><option value="L" ${oldJk === 'L' ? 'selected' : ''}>Laki-laki</option><option value="P" ${oldJk === 'P' ? 'selected' : ''}>Perempuan</option></select><label class="block text-sm font-medium mt-4">Pindah ke Kelas</label><select id="modal-kelas-pindah" class="mt-1 block w-full p-2 border rounded-md"><option value="${kelas}">Jangan Pindah</option>${Object.keys(dataSiswa).sort().filter(k => k !== kelas).map(k => `<option value="${k}">${k}</option>`).join('')}</select>`;
            showModalWithInputs(`Edit Data Siswa`, bodyHtml, () => {
                const newNama = document.getElementById('modal-nama').value;
                if (!newNama) { showNotification('⚠️ Nama harus diisi!', 'warning'); return; }
                editSiswa(kelas, oldNis, newNama, document.getElementById('modal-jk').value, document.getElementById('modal-kelas-pindah').value);
            });
        }
        
        function showModal(title, message, onConfirm) {
            const existingModal = document.getElementById('customModal');
            if (existingModal) existingModal.remove();
            let modalHtml = `<div id="customModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full z-[100] flex items-center justify-center p-4"><div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-2xl bg-white"><div class="mt-3 text-center"><h3 class="text-lg font-medium">${title}</h3><div class="mt-2 px-7 py-3"><p class="text-sm text-gray-500">${message}</p></div><div class="items-center px-4 py-3 flex gap-3"><button id="cancelBtn" class="p-2 bg-gray-200 rounded-md w-full">Batal</button><button id="confirmBtn" class="p-2 bg-red-500 text-white rounded-md w-full">Hapus</button></div></div></div></div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const closeModal = () => document.getElementById('customModal').remove();
            document.getElementById('confirmBtn').onclick = () => { onConfirm(); closeModal(); };
            document.getElementById('cancelBtn').onclick = closeModal;
        }

        function showModalWithInputs(title, bodyHtml, onSave) {
            const existingModal = document.getElementById('customModal');
            if (existingModal) existingModal.remove();
            let modalHtml = `<div id="customModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full z-[100] flex items-center justify-center p-4"><div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-2xl bg-white"><div class="mt-3"><h3 class="text-lg font-medium text-center">${title}</h3><div class="mt-4 px-4 py-3 text-left space-y-4">${bodyHtml}</div><div class="items-center px-4 py-3 flex gap-3 mt-4"><button id="cancelBtn" class="p-2 bg-gray-200 rounded-md w-full">Batal</button><button id="saveBtn" class="p-2 bg-blue-500 text-white rounded-md w-full">Simpan</button></div></div></div></div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const closeModal = () => document.getElementById('customModal').remove();
            document.getElementById('saveBtn').onclick = () => { onSave(); closeModal(); };
            document.getElementById('cancelBtn').onclick = closeModal;
        }
    </script>
</body>
</html>
